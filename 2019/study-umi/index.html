<!DOCTYPE html>
<html>
<head><meta name="generator" content="Hexo 3.9.0">
    

    

    
<!-- Baidu Tongji -->
<script>var _hmt = _hmt || []</script>
<script async src="//hm.baidu.com/hm.js?887dce1cce44879d8dedd9d9ad97b6d9"></script>
<!-- End Baidu Tongji -->


    <meta charset="utf-8">
    
    
    
    <title>学习UMI | 草庙村 | 个人博客</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    
    <meta name="theme-color" content="#3F51B5">
    
    
    <meta name="keywords" content="前端,笔记">
    <meta name="description" content="第一次认真学习开源项目，看一次开源代码…">
<meta name="keywords" content="前端,笔记">
<meta property="og:type" content="article">
<meta property="og:title" content="学习UMI">
<meta property="og:url" content="https://shawdanon.github.io/2019/study-umi/index.html">
<meta property="og:site_name" content="草庙村">
<meta property="og:description" content="第一次认真学习开源项目，看一次开源代码…">
<meta property="og:locale" content="zh-CN">
<meta property="og:image" content="https://shawdanon.github.io/img/2019/5-27-1.png">
<meta property="og:image" content="https://shawdanon.github.io/img/2019/5-27-2.png">
<meta property="og:updated_time" content="2019-07-28T05:15:18.296Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="学习UMI">
<meta name="twitter:description" content="第一次认真学习开源项目，看一次开源代码…">
<meta name="twitter:image" content="https://shawdanon.github.io/img/2019/5-27-1.png">
    
        <link rel="alternate" type="application/atom+xml" title="草庙村" href="/atom.xml">
    
    <link rel="shortcut icon" href="/img/favicon.ico">
    <link rel="stylesheet" href="/css/style.css?v=1.7.1">
    <script>window.lazyScripts=[]</script>

    <!-- custom head -->
    

</head>

<body>
    <div id="loading" class="active"></div>

    <aside id="menu" class="hide" >
  <div class="inner flex-row-vertical">
    <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="menu-off">
        <i class="icon icon-lg icon-close"></i>
    </a>
    <div class="brand-wrap" style="background-image:url(/img/brand.jpg)">
      <div class="brand">
        <a href="/" class="avatar waves-effect waves-circle waves-light">
          <img src="/img/avatar.jpg">
        </a>
        <hgroup class="introduce">
          <h5 class="nickname">鬼厉</h5>
          <a href="mailto:me@imtxp.cn" title="me@imtxp.cn" class="mail">me@imtxp.cn</a>
        </hgroup>
      </div>
    </div>
    <div class="scroll-wrap flex-col">
      <ul class="nav">
        
            <li class="waves-block waves-effect">
              <a href="/"  >
                <i class="icon icon-lg icon-home"></i>
                主页
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="/archives"  >
                <i class="icon icon-lg icon-archives"></i>
                归档
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="/tags"  >
                <i class="icon icon-lg icon-tags"></i>
                标签
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="/categories"  >
                <i class="icon icon-lg icon-th-list"></i>
                分类
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="/nav"  >
                <i class="icon icon-lg icon-folder"></i>
                常用网址
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="/time"  >
                <i class="icon icon-lg icon-times"></i>
                倒计时
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="https://github.com/ShawDanon" target="_blank" >
                <i class="icon icon-lg icon-github"></i>
                Github
              </a>
            </li>
        
      </ul>
    </div>
  </div>
</aside>

    <main id="main">
        <header class="top-header" id="header">
    <div class="flex-row">
        <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light on" id="menu-toggle">
          <i class="icon icon-lg icon-navicon"></i>
        </a>
        <div class="flex-col header-title ellipsis">学习UMI</div>
        
        <div class="search-wrap" id="search-wrap">
            <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="back">
                <i class="icon icon-lg icon-chevron-left"></i>
            </a>
            <input type="text" id="key" class="search-input" autocomplete="off" placeholder="输入感兴趣的关键字">
            <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="search">
                <i class="icon icon-lg icon-search"></i>
            </a>
        </div>
        
        
        <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="menuShare">
            <i class="icon icon-lg icon-share-alt"></i>
        </a>
        
    </div>
</header>
<header class="content-header post-header">

    <div class="container fade-scale">
        <h1 class="title">学习UMI</h1>
        <h5 class="subtitle">
            
                <time datetime="2019-03-01T16:00:00.000Z" itemprop="datePublished" class="page-time">
  2019年03月02日
</time>


	<ul class="article-category-list"><li class="article-category-list-item"><a class="article-category-list-link" href="/categories/技术/">技术</a></li></ul>

            
        </h5>
    </div>

    


</header>


<div class="container body-wrap">
    
    <aside class="post-widget">
        <nav class="post-toc-wrap" id="post-toc">
            <h4>TOC</h4>
            <ol class="post-toc"><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#学习-UMI（一）"><span class="post-toc-number">1.</span> <span class="post-toc-text">学习 UMI（一）</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#目录"><span class="post-toc-number">1.1.</span> <span class="post-toc-text">目录</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#一级目录"><span class="post-toc-number">1.2.</span> <span class="post-toc-text">一级目录</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#package-json"><span class="post-toc-number">1.2.1.</span> <span class="post-toc-text">package.json</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#Lerna"><span class="post-toc-number">1.2.2.</span> <span class="post-toc-text">Lerna</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#Travis"><span class="post-toc-number">1.2.3.</span> <span class="post-toc-text">Travis</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#Jest"><span class="post-toc-number">1.2.4.</span> <span class="post-toc-text">Jest</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#EditorConfig"><span class="post-toc-number">1.2.5.</span> <span class="post-toc-text">EditorConfig</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#ESLint"><span class="post-toc-number">1.2.6.</span> <span class="post-toc-text">ESLint</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#Typescript"><span class="post-toc-number">1.2.7.</span> <span class="post-toc-text">Typescript</span></a></li></ol></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#scripts-文件夹"><span class="post-toc-number">1.3.</span> <span class="post-toc-text">scripts 文件夹</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#build-js"><span class="post-toc-number">1.3.1.</span> <span class="post-toc-text">build.js</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#publish-js"><span class="post-toc-number">1.3.2.</span> <span class="post-toc-text">publish.js</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#startDevServers-js"><span class="post-toc-number">1.3.3.</span> <span class="post-toc-text">startDevServers.js</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#test-js"><span class="post-toc-number">1.3.4.</span> <span class="post-toc-text">test.js</span></a></li></ol></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#总结"><span class="post-toc-number">1.4.</span> <span class="post-toc-text">总结</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#2019-3-31"><span class="post-toc-number">1.4.1.</span> <span class="post-toc-text">2019/3/31</span></a></li></ol></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#demo-地址"><span class="post-toc-number">1.5.</span> <span class="post-toc-text">demo 地址</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#参考一"><span class="post-toc-number">1.6.</span> <span class="post-toc-text">参考一</span></a></li></ol></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#学习-UMI（二）"><span class="post-toc-number">2.</span> <span class="post-toc-text">学习 UMI（二）</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#packages-umi"><span class="post-toc-number">2.1.</span> <span class="post-toc-text">packages/umi</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#重要的"><span class="post-toc-number">2.1.1.</span> <span class="post-toc-text">重要的</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-5"><a class="post-toc-link" href="#packages-umi-package-json"><span class="post-toc-number">2.1.1.1.</span> <span class="post-toc-text">packages/umi/package.json</span></a></li></ol></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#提供接口相关的文件"><span class="post-toc-number">2.1.2.</span> <span class="post-toc-text">提供接口相关的文件</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-5"><a class="post-toc-link" href="#packages-umi-index-js"><span class="post-toc-number">2.1.2.1.</span> <span class="post-toc-text">packages/umi/index.js</span></a></li><li class="post-toc-item post-toc-level-5"><a class="post-toc-link" href="#packages-umi-link-js"><span class="post-toc-number">2.1.2.2.</span> <span class="post-toc-text">packages/umi/link.js</span></a></li><li class="post-toc-item post-toc-level-5"><a class="post-toc-link" href="#packages-umi-NavLink-js"><span class="post-toc-number">2.1.2.3.</span> <span class="post-toc-text">packages/umi/NavLink.js</span></a></li><li class="post-toc-item post-toc-level-5"><a class="post-toc-link" href="#packages-umi-Redirect-js"><span class="post-toc-number">2.1.2.4.</span> <span class="post-toc-text">packages/umi/Redirect.js</span></a></li><li class="post-toc-item post-toc-level-5"><a class="post-toc-link" href="#packages-umi-router-js"><span class="post-toc-number">2.1.2.5.</span> <span class="post-toc-text">packages/umi/router.js</span></a></li><li class="post-toc-item post-toc-level-5"><a class="post-toc-link" href="#packages-umi-withRouter-js"><span class="post-toc-number">2.1.2.6.</span> <span class="post-toc-text">packages/umi/withRouter.js</span></a></li><li class="post-toc-item post-toc-level-5"><a class="post-toc-link" href="#packages-umi-Route-js"><span class="post-toc-number">2.1.2.7.</span> <span class="post-toc-text">packages/umi/Route.js</span></a></li><li class="post-toc-item post-toc-level-5"><a class="post-toc-link" href="#packages-umi-dynamic-js"><span class="post-toc-number">2.1.2.8.</span> <span class="post-toc-text">packages/umi/dynamic.js</span></a></li></ol></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#命令相关的文件"><span class="post-toc-number">2.1.3.</span> <span class="post-toc-text">命令相关的文件</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-5"><a class="post-toc-link" href="#packages-umi-bin-umi-js"><span class="post-toc-number">2.1.3.1.</span> <span class="post-toc-text">packages/umi/bin/umi.js</span></a></li><li class="post-toc-item post-toc-level-5"><a class="post-toc-link" href="#packages-umi-src-cli-js"><span class="post-toc-number">2.1.3.2.</span> <span class="post-toc-text">packages/umi/src/cli.js</span></a></li><li class="post-toc-item post-toc-level-5"><a class="post-toc-link" href="#packages-umi-src-buildDevOpts-js"><span class="post-toc-number">2.1.3.3.</span> <span class="post-toc-text">packages/umi/src/buildDevOpts.js</span></a></li><li class="post-toc-item post-toc-level-5"><a class="post-toc-link" href="#packages-umi-src-scripts-build-js"><span class="post-toc-number">2.1.3.4.</span> <span class="post-toc-text">packages/umi/src/scripts/build.js</span></a></li><li class="post-toc-item post-toc-level-5"><a class="post-toc-link" href="#packages-umi-src-scripts-dev-js"><span class="post-toc-number">2.1.3.5.</span> <span class="post-toc-text">packages/umi/src/scripts/dev.js</span></a></li><li class="post-toc-item post-toc-level-5"><a class="post-toc-link" href="#packages-umi-src-scripts-inspect-js"><span class="post-toc-number">2.1.3.6.</span> <span class="post-toc-text">packages/umi/src/scripts/inspect.js</span></a></li><li class="post-toc-item post-toc-level-5"><a class="post-toc-link" href="#packages-umi-src-scripts-realDev-js"><span class="post-toc-number">2.1.3.7.</span> <span class="post-toc-text">packages/umi/src/scripts/realDev.js</span></a></li></ol></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#其他"><span class="post-toc-number">2.1.4.</span> <span class="post-toc-text">其他</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-5"><a class="post-toc-link" href="#packages-umi-src-test-js"><span class="post-toc-number">2.1.4.1.</span> <span class="post-toc-text">packages/umi/src/test.js</span></a></li><li class="post-toc-item post-toc-level-5"><a class="post-toc-link" href="#packages-umi-src-babel-js"><span class="post-toc-number">2.1.4.2.</span> <span class="post-toc-text">packages/umi/src/babel.js</span></a></li><li class="post-toc-item post-toc-level-5"><a class="post-toc-link" href="#packages-umi-src-createHistory-js"><span class="post-toc-number">2.1.4.3.</span> <span class="post-toc-text">packages/umi/src/createHistory.js</span></a></li><li class="post-toc-item post-toc-level-5"><a class="post-toc-link" href="#packages-umi-src-prompt-js"><span class="post-toc-number">2.1.4.4.</span> <span class="post-toc-text">packages/umi/src/prompt.js</span></a></li><li class="post-toc-item post-toc-level-5"><a class="post-toc-link" href="#packages-umi-src-renderRoutes-js"><span class="post-toc-number">2.1.4.5.</span> <span class="post-toc-text">packages/umi/src/renderRoutes.js</span></a></li><li class="post-toc-item post-toc-level-5"><a class="post-toc-link" href="#packages-umi-src-runtimePlugin-js"><span class="post-toc-number">2.1.4.6.</span> <span class="post-toc-text">packages/umi/src/runtimePlugin.js</span></a></li><li class="post-toc-item post-toc-level-5"><a class="post-toc-link" href="#packages-umi-src-utils-js"><span class="post-toc-number">2.1.4.7.</span> <span class="post-toc-text">packages/umi/src/utils.js</span></a></li></ol></li></ol></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#packages-umi-utils"><span class="post-toc-number">2.2.</span> <span class="post-toc-text">packages/umi-utils</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#packages-umi-utils-src-winPath-js"><span class="post-toc-number">2.2.1.</span> <span class="post-toc-text">packages/umi-utils/src/winPath.js</span></a></li></ol></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#总结-4-30"><span class="post-toc-number">2.3.</span> <span class="post-toc-text">总结 4/30</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#参考二"><span class="post-toc-number">2.4.</span> <span class="post-toc-text">参考二</span></a></li></ol></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#学习-UMI（三）"><span class="post-toc-number">3.</span> <span class="post-toc-text">学习 UMI（三）</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#运行-umi-代码"><span class="post-toc-number">3.1.</span> <span class="post-toc-text">运行 umi 代码</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#inspect"><span class="post-toc-number">3.2.</span> <span class="post-toc-text">inspect</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#umi-命令内部运行过程"><span class="post-toc-number">3.3.</span> <span class="post-toc-text">umi 命令内部运行过程</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#看过的一些源码及注释-packages-umi-build-dev"><span class="post-toc-number">3.4.</span> <span class="post-toc-text">看过的一些源码及注释 packages/umi-build-dev</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#packages-umi-build-dev-src-Service"><span class="post-toc-number">3.4.1.</span> <span class="post-toc-text">packages/umi-build-dev/src/Service</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#packages-umi-build-dev-src-registerBabel"><span class="post-toc-number">3.4.2.</span> <span class="post-toc-text">packages/umi-build-dev/src/registerBabel</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#packages-umi-build-dev-src-UserConfig"><span class="post-toc-number">3.4.3.</span> <span class="post-toc-text">packages/umi-build-dev/src/UserConfig</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#packages-umi-build-dev-src-getPaths"><span class="post-toc-number">3.4.4.</span> <span class="post-toc-text">packages/umi-build-dev/src/getPaths</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#packages-umi-build-dev-src-utils-deprecate"><span class="post-toc-number">3.4.5.</span> <span class="post-toc-text">packages/umi-build-dev/src/utils/deprecate</span></a></li></ol></li></ol></li></ol>
        </nav>
    </aside>
    
<article id="post-2019/study-umi"
  class="post-article article-type-post fade" itemprop="blogPost">

    <div class="post-card">
        <h1 class="post-card-title">学习UMI</h1>
        <div class="post-meta">
            <time class="post-time" title="2019年03月02日 00:00:00" datetime="2019-03-01T16:00:00.000Z"  itemprop="datePublished">2019年03月02日</time>

            
	<ul class="article-category-list"><li class="article-category-list-item"><a class="article-category-list-link" href="/categories/技术/">技术</a></li></ul>



            

        </div>
        <div class="post-content" id="post-content" itemprop="postContent">
            <p>第一次认真学习开源项目，看一次开源代码…</p>
<a id="more"></a>
<h2 id="学习-UMI（一）"><a href="#学习-UMI（一）" class="headerlink" title="学习 UMI（一）"></a>学习 UMI（一）</h2><p><a href="mailto:umi@2.6.17" target="_blank" rel="noopener">umi@2.6.17</a></p>
<h3 id="目录"><a href="#目录" class="headerlink" title="目录"></a>目录</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> DirectoryTree = &#123;</span><br><span class="line">  <span class="string">'.github'</span>: &#123; <span class="attr">dec</span>: <span class="literal">undefined</span>, <span class="attr">child</span>: <span class="literal">null</span> &#125;,</span><br><span class="line">  docs: &#123; <span class="attr">dec</span>: <span class="string">'说明文档'</span>, <span class="attr">child</span>: <span class="literal">null</span> &#125;,</span><br><span class="line">  examples: &#123; <span class="attr">dec</span>: <span class="string">'例子'</span>, <span class="attr">child</span>: <span class="literal">null</span> &#125;,</span><br><span class="line">  packages: &#123;</span><br><span class="line">    dec: <span class="string">'npm包'</span>,</span><br><span class="line">    child: &#123;</span><br><span class="line">      <span class="string">'af-webpack'</span>: <span class="literal">null</span>,</span><br><span class="line">      <span class="string">'babel-preset-umi'</span>: <span class="literal">null</span>,</span><br><span class="line">      <span class="string">'eslint-config-umi'</span>: <span class="literal">null</span>,</span><br><span class="line">      umi: <span class="literal">null</span>,</span><br><span class="line">      <span class="string">'umi-build-dev'</span>: <span class="literal">null</span>,</span><br><span class="line">      <span class="string">'umi-core'</span>: <span class="literal">null</span>,</span><br><span class="line">      <span class="string">'umi-library'</span>: <span class="literal">null</span>,</span><br><span class="line">      <span class="string">'umi-mock'</span>: <span class="literal">null</span>,</span><br><span class="line">      <span class="string">'umi-plugin-dll'</span>: <span class="literal">null</span>,</span><br><span class="line">      <span class="string">'umi-plugin-dva'</span>: <span class="literal">null</span>,</span><br><span class="line">      <span class="string">'umi-plugin-hd'</span>: <span class="literal">null</span>,</span><br><span class="line">      <span class="string">'umi-plugin-locale'</span>: <span class="literal">null</span>,</span><br><span class="line">      <span class="string">'umi-plugin-polyfills'</span>: <span class="literal">null</span>,</span><br><span class="line">      <span class="string">'umi-plugin-react'</span>: <span class="literal">null</span>,</span><br><span class="line">      <span class="string">'umi-plugin-routes'</span>: <span class="literal">null</span>,</span><br><span class="line">      <span class="string">'umi-serve'</span>: <span class="literal">null</span>,</span><br><span class="line">      <span class="string">'umi-test'</span>: <span class="literal">null</span>,</span><br><span class="line">      <span class="string">'umi-types'</span>: <span class="literal">null</span>,</span><br><span class="line">      <span class="string">'umi-utils'</span>: <span class="literal">null</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  scripts: &#123;</span><br><span class="line">    dec: <span class="string">'脚本'</span>,</span><br><span class="line">    child: &#123;</span><br><span class="line">      <span class="string">'build.js'</span>: <span class="string">'构建脚本'</span>,</span><br><span class="line">      <span class="string">'publish.js'</span>: <span class="string">'发布脚本'</span>,</span><br><span class="line">      <span class="string">'reinstall_deps.sh'</span>: <span class="literal">undefined</span>,</span><br><span class="line">      <span class="string">'startDevServers.js'</span>: <span class="string">'启动开发服务脚本'</span>,</span><br><span class="line">      <span class="string">'test.js'</span>: <span class="string">'测试脚本'</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  website: <span class="literal">null</span>,</span><br><span class="line">  <span class="string">'.editorconfig'</span>: <span class="string">'EditorConfig配置文件|EditorConfig有助于为跨越各种编辑器和IDE的同一项目的多个开发人员维护一致的编码样式'</span>,</span><br><span class="line">  <span class="string">'.eslintignore'</span>: <span class="string">'设置ESlint不跟踪的文件，同.gitignore一样'</span>,</span><br><span class="line">  <span class="string">'.eslintrc'</span>: <span class="string">'ESlint配置文件|JavaScript代码检测, JavaScript代码风格检测, JavaScript代码自动格式化'</span>,</span><br><span class="line">  <span class="string">'.gitignore'</span>: <span class="string">'设置git不跟踪的文件'</span>,</span><br><span class="line">  <span class="string">'.prettierignore'</span>: <span class="string">'设置Prettier不跟踪的文件，同.gitignore一样|Prettier是一个前端代码格式化工具'</span>,</span><br><span class="line">  <span class="string">'.travis.yml'</span>: <span class="string">'Travis配置文件|Travis CI 提供的是持续集成服务'</span>,</span><br><span class="line">  <span class="string">'.yarnrc'</span>: <span class="string">'yarn配置文件，配置了使用官方镜像源'</span>,</span><br><span class="line">  <span class="string">'jasmine.js'</span>: <span class="string">' Jasmine配置文件|Jasmine是一个测试框架，配置了超时时间'</span>,</span><br><span class="line">  <span class="string">'jest.config.js'</span>: <span class="string">'jest配置文件'</span>,</span><br><span class="line">  <span class="string">'lerna.json'</span>: <span class="string">'lerna配置文件|Lerna 是一个用来优化托管在git、npm上的多package代码库的工作流的一个管理工具。'</span>,</span><br><span class="line">  <span class="string">'package.json'</span>: <span class="literal">null</span>,</span><br><span class="line">  <span class="string">'（废弃集成到了umi-tools中）rollup.config.js'</span>: <span class="string">'rollup配置文件|rollup是一款打包工具'</span>,</span><br><span class="line">  <span class="string">'tsconfig.json'</span>: <span class="string">'TypeScript配置文件|指定ts编译的一些参数信息'</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>整个目录看下来光工具和包很多都没接触过，代码检查有用过 eslint，项目落地还是不多，这个月看来要恶补一番前端开发规范啊。</p>
<h3 id="一级目录"><a href="#一级目录" class="headerlink" title="一级目录"></a>一级目录</h3><h4 id="package-json"><a href="#package-json" class="headerlink" title="package.json"></a>package.json</h4><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  "private": true, //私有，防止npm意外发布</span><br><span class="line">  "scripts": &#123;</span><br><span class="line">    "bootstrap": "lerna bootstrap",</span><br><span class="line">    "build": "./scripts/build.js",</span><br><span class="line">    "changelog": "lerna-changelog",</span><br><span class="line">    "chore:update-deps": "./scripts/update_deps.sh",</span><br><span class="line">    "test": "node scripts/test.js",</span><br><span class="line">    "test:coverage": "./packages/umi-test/bin/umi-test.js --coverage",</span><br><span class="line">    "debug": "./packages/umi-test/bin/umi-test.js",</span><br><span class="line">    "coveralls": "cat ./coverage/lcov.info | coveralls",</span><br><span class="line">    "lint": "eslint --ext .js packages",</span><br><span class="line">    "precommit": "lint-staged",</span><br><span class="line">    "doc:dev": "./website/node_modules/.bin/vuepress dev ./docs",</span><br><span class="line">    "doc:deploy": "rm -rf ./website/yarn.lock &amp;&amp; cd ./website &amp;&amp; npm run deploy &amp;&amp; cd -",</span><br><span class="line">    "publish": "./scripts/publish.js",</span><br><span class="line">    "ui:dev": "APP_ROOT=packages/umi-build-dev/src/plugins/commands/ui ./packages/umi/bin/umi.js dev",</span><br><span class="line">    "ui:build": "APP_ROOT=packages/umi-build-dev/src/plugins/commands/ui ./packages/umi/bin/umi.js build"</span><br><span class="line">  &#125;, //脚本</span><br><span class="line">  "lint-staged": &#123;</span><br><span class="line">    "*.(t|j)s": ["prettier --trailing-comma all --single-quote --write", "git add"]</span><br><span class="line">  &#125;,</span><br><span class="line">  "devDependencies": &#123;</span><br><span class="line">    "@types/jest": "^24.0.5", //Jest的TypeScript定义</span><br><span class="line">    "babel-eslint": "10.0.1", //eslint的解析器，一个对Babel解析器的包装，使其能够与 ESLint 兼容。</span><br><span class="line">    "chokidar": "2.0.4", //监听文件变化</span><br><span class="line">    "coveralls": "3.0.2", //代码覆盖率</span><br><span class="line">    "dva": "2.4.1", //数据流管理</span><br><span class="line">    "eslint": "5.10.0", //可组装的JavaScript和JSX检查工具</span><br><span class="line">    "eslint-config-airbnb": "17.1.0", //airbnb的eslint规范</span><br><span class="line">    "eslint-plugin-import": "2.14.0", //导入导出文件检查</span><br><span class="line">    "eslint-plugin-jsx-a11y": "6.1.2", //用于JSX元素的可访问性规则的静态AST检查器</span><br><span class="line">    "eslint-plugin-react": "7.11.1", //react检查器扩展插件</span><br><span class="line">    "form-data": "^2.3.3", //用于创建可读"multipart/form-data"流的库。可用于将表单和文件上载提交到其他Web应用程序。</span><br><span class="line">    "got": "9.3.2", //简化的HTTP请求</span><br><span class="line">    "husky": "1.2.0", //git commit、git push前检查代码</span><br><span class="line">    "lerna": "3.6.0", //包管理工具</span><br><span class="line">    "lerna-changelog": "0.8.2", //为 Lerna repo  生成变更日志</span><br><span class="line">    "lint-staged": "8.1.0", //提交前运行阻止提交不合规范代码</span><br><span class="line">    "mkdirp": "^0.5.1", //递归创建目录及其子目录,代替mkdir -p</span><br><span class="line">    "prettier": "1.15.3", //格式化</span><br><span class="line">    "puppeteer": "1.11.0", //Puppeteer是一个Node库，它提供了一个高级API来控制DevTools协议上的 Chrome或Chromium 。</span><br><span class="line">    "react-router-dom": "4.3.1", //react路由</span><br><span class="line">    "react-test-renderer": "16.6.3", //单元测试</span><br><span class="line">    "serve-handler": "5.0.8", //此包代表正在运行的服务和静态部署的核心。</span><br><span class="line">    "serve-static": "^1.13.2", //这是一个通过npm注册表提供的Node.js模块。</span><br><span class="line">    "shelljs": "0.8.3", //ShellJS是Node.js API之上的Unix shell命令的可移植（Windows / Linux / OS X）实现。</span><br><span class="line">    "test-build-result": "^1.1.2", //测试构建结果</span><br><span class="line">    "umi-tools": "^0.4.0" //用于构建umi的工具。</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="Lerna"><a href="#Lerna" class="headerlink" title="Lerna"></a>Lerna</h4><p>从目录架构来看，首先要学的是多包管理与发布。通过多包管理可以把作者多个包放在一起用一个仓库储存来维护。（PS：npm 包上传后不能删除，强迫症患者需要慎重取名）</p>
<p>使用说明：</p>
<ol>
<li>全局安装 lerna 包<code>npm install lerna -g</code>。</li>
<li>在 github 创建一个仓库，并拉下来备用。</li>
<li>在该仓库根目录初始化 lerna<code>lerna init</code>。<br>初始化成功会多出 3 个文件： packages(目录，用于存放包)、 lerna.json(配置文件，用于 lerna 配置)、package.json(工程描述文件)</li>
<li>修改 lerna.json 文件中的 version 值，默认是<code>&quot;version&quot;: &quot;0.0.0&quot;</code>（使用这个模式，在发布包的时候所有的包都会发布，并使用 lerna.json 中设置的版本号），修改为<code>&quot;version&quot;: &quot;independent&quot;</code>（使用这个模式，可以单独发布包更新，可喜的是发布包可以自动生成版本号供你选择）。</li>
<li>在 packages 目录中创建自己的包，在当前包目录执行<code>lerna publish</code>来发布包。（发布包需要确定 npm 镜像源是<code>https://registry.npmjs.org/</code>，发布包前需要登录 npm，使用<code>npm login</code>登录。）</li>
</ol>
<p>常用命令：</p>
<ol>
<li><code>lerna init</code>：创建新的 lerna repo 或将现有 repo 升级到当前版本的 Lerna。</li>
<li><code>lerna bootstrap</code>：将把 repo 中的依赖关系链接在一起。</li>
<li><code>lerna publish</code>：将帮助发布任何更新的包。</li>
</ol>
<p>基本使用会了，让我们回到 umi 中看看<code>lerna.json</code>都配置了些什么。</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"changelog"</span>: &#123;</span><br><span class="line">    <span class="attr">"labels"</span>: &#123;</span><br><span class="line">      "pr: enhancement": ":rocket: Enhancement", //增强</span><br><span class="line">      "pr: bug": ":bug: Bug Fix", //错误修复</span><br><span class="line">      "pr: documentation": ":book: Documentation", //文档</span><br><span class="line">      "pr: dependency": ":deciduous_tree: Dependency"</span><br><span class="line">    &#125;, //GitHub PR标签映射到changelog部分标头</span><br><span class="line">    "repo": "umijs/umi", //你在GitHub上的“组织/回购”（从package.json文件中自动推断）</span><br><span class="line">    "cacheDir": ".changelog" //GitHub API响应缓存的路径以避免限制（例如.changelog）</span><br><span class="line">  &#125;,</span><br><span class="line">  "packages": ["packages/*"], //包位置</span><br><span class="line">  "command": &#123;</span><br><span class="line">    "version": &#123;</span><br><span class="line">      "exact": true</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  "npmClient": "yarn", //一个选项，用于指定运行命令的特定客户端（也可以基于每个命令指定）。更改为"yarn"使用yarn运行所有命令。默认为“npm”</span><br><span class="line">  "version": "independent" //存储库的当前版本，使用独立模式</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="Travis"><a href="#Travis" class="headerlink" title="Travis"></a>Travis</h4><p>Travis 是一款持续集成工具。那么持续集成是什么呢？</p>
<blockquote>
<p>持续集成是一种软件开发实践，即团队开发成员经常集成它们的工作，通过每个成员每天至少集成一次，也就意味着每天可能会发生多次集成。每次集成都通过自动化的构建（包括编译，发布，自动化测试）来验证，从而尽早地发现集成错误。</p>
</blockquote>
<p>如何使用 Travis？</p>
<ol>
<li>在 Travis 官网使用 github 账号注册登录，会看到你仓库所有的项目。</li>
<li>打开你想持续集成的项目开关。</li>
<li>在该项目创建<code>.travis.yml</code>文件，文件内容至少包含<code>language: node_js</code>和<code>node_js: - &#39;6&#39;</code></li>
<li>提交代码，Travis 就会自动进行构建了。</li>
<li>构建成功会在 Travis 中显示 build pass 的按钮，点击按钮会有个弹窗，选择 markdown 格式复制链接到项目 readme 中就拥有构建徽章了。</li>
</ol>
<p>大概了解了下 Travis，接下来看看 umi 中<code>.travis.yml</code>文件写了些什么。</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 指定语言</span></span><br><span class="line"><span class="attr">language:</span> <span class="string">node_js</span></span><br><span class="line"><span class="comment"># 指定版本</span></span><br><span class="line"><span class="attr">node_js:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">'8'</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">'10'</span></span><br><span class="line"><span class="comment"># 脚本阶段之前</span></span><br><span class="line"><span class="attr">before_script:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">npm</span> <span class="string">run</span> <span class="string">build</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">npm</span> <span class="string">run</span> <span class="string">bootstrap</span></span><br><span class="line"><span class="comment"># 构建成功</span></span><br><span class="line"><span class="attr">after_success:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">npm</span> <span class="string">run</span> <span class="string">coveralls</span></span><br><span class="line"><span class="comment"># 缓存Node.js模块</span></span><br><span class="line"><span class="attr">cache:</span></span><br><span class="line"><span class="attr">  directories:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">node_modules</span></span><br><span class="line"></span><br><span class="line"><span class="attr">git:</span></span><br><span class="line"><span class="attr">  depth:</span> <span class="number">5</span></span><br></pre></td></tr></table></figure>
<h4 id="Jest"><a href="#Jest" class="headerlink" title="Jest"></a>Jest</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  testPathIgnorePatterns: [</span><br><span class="line">    <span class="string">'/node_modules/'</span>,</span><br><span class="line">    <span class="string">'/examples/'</span>,</span><br><span class="line">    <span class="string">'/lib/'</span>,</span><br><span class="line">    <span class="string">'/packages/umi/src/scripts/test.js'</span>,</span><br><span class="line">    <span class="string">'/packages/umi/src/test.js'</span>,</span><br><span class="line">    <span class="string">'/packages/umi-build-dev/src/fixtures'</span>,</span><br><span class="line">    <span class="string">'/packages/umi-build-dev/src/routes/fixtures'</span>,</span><br><span class="line">    <span class="string">'/packages/umi-plugin-dva/src/fixtures'</span>,</span><br><span class="line">    <span class="string">'/packages/umi-utils/src/fixtures'</span>,</span><br><span class="line">    <span class="string">'/packages/umi-library/src/fixtures'</span>,</span><br><span class="line">    <span class="string">'/packages/umi/test/fixtures'</span></span><br><span class="line">  ], <span class="comment">//排除测试的文件</span></span><br><span class="line">  setupFilesAfterEnv: [<span class="string">'./jasmine.js'</span>], <span class="comment">//在每次测试之前运行一些代码以配置或设置测试框架的模块的路径列表。</span></span><br><span class="line">  collectCoverageFrom: [<span class="string">'packages/**/src/**/*.&#123;js,jsx&#125;'</span>], <span class="comment">//应收集覆盖率信息的一组文件。</span></span><br><span class="line">  coveragePathIgnorePatterns: [</span><br><span class="line">    <span class="string">'/packages/umi-plugin-dva/src/fixtures'</span>,</span><br><span class="line">    <span class="string">'/packages/umi-build-dev/src/fixtures'</span>,</span><br><span class="line">    <span class="string">'/packages/umi-build-dev/src/routes/fixtures'</span>,</span><br><span class="line">    <span class="string">'/packages/umi-build-dev/src/plugins/commands/generate/generators'</span>,</span><br><span class="line">    <span class="string">'/packages/umi-library/src/fixtures'</span>,</span><br><span class="line">    <span class="string">'/packages/umi-utils/src/fixtures'</span>,</span><br><span class="line">    <span class="string">'/packages/umi/test/fixtures'</span></span><br><span class="line">  ] <span class="comment">//覆盖率排除的文件。</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h4 id="EditorConfig"><a href="#EditorConfig" class="headerlink" title="EditorConfig"></a>EditorConfig</h4><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># http://editorconfig.org</span></span><br><span class="line"><span class="comment">#应在任何部分之外的文件顶部指定的特殊属性。设置为true以停止.editorconfig在当前文件上搜索文件。</span></span><br><span class="line"><span class="attr">root</span> = <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#所有文件配置</span></span><br><span class="line"><span class="section">[*]</span></span><br><span class="line"><span class="comment">#设置缩进风格为空格</span></span><br><span class="line"><span class="attr">indent_style</span> = space</span><br><span class="line"><span class="comment">#缩进大小（单行间距）</span></span><br><span class="line"><span class="attr">indent_size</span> = <span class="number">2</span></span><br><span class="line"><span class="comment">#行结束文件格式（Unix，DOS，Mac）换行符</span></span><br><span class="line"><span class="attr">end_of_line</span> = lf</span><br><span class="line"><span class="comment">#文件字符编码</span></span><br><span class="line"><span class="attr">charset</span> = utf-<span class="number">8</span></span><br><span class="line"><span class="comment">#设置为true以删除换行符前面的任何空白字符，并设置为false以确保不会。</span></span><br><span class="line"><span class="attr">trim_trailing_whitespace</span> = <span class="literal">true</span></span><br><span class="line"><span class="comment">#设置为真以换行符节能时，确保文件最终假，以确保它不会。</span></span><br><span class="line"><span class="attr">insert_final_newline</span> = <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="section">[*.md]</span></span><br><span class="line"><span class="attr">trim_trailing_whitespace</span> = <span class="literal">false</span></span><br><span class="line"></span><br><span class="line"><span class="section">[Makefile]</span></span><br><span class="line"><span class="attr">indent_style</span> = tab</span><br></pre></td></tr></table></figure>
<h4 id="ESLint"><a href="#ESLint" class="headerlink" title="ESLint"></a>ESLint</h4><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  "parser": "babel-eslint", //指定解析器</span><br><span class="line">  "extends": "airbnb", //使用airbnb配置扩展</span><br><span class="line">  "env": &#123;</span><br><span class="line">    "browser": true,</span><br><span class="line">    "jest": true</span><br><span class="line">  &#125;, //指定配置文件中的环境</span><br><span class="line">  "rules": &#123;</span><br><span class="line">    "jsx-a11y/href-no-hash": [0],</span><br><span class="line">    "jsx-a11y/click-events-have-key-events": [0],</span><br><span class="line">    "jsx-a11y/anchor-is-valid": [</span><br><span class="line">      "error",</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">"components"</span>: [<span class="string">"Link"</span>],</span><br><span class="line">        <span class="attr">"specialLink"</span>: [<span class="string">"to"</span>]</span><br><span class="line">      &#125;</span><br><span class="line">    ],</span><br><span class="line">    "generator-star-spacing": [0],</span><br><span class="line">    "consistent-return": [0],</span><br><span class="line">    "react/react-in-jsx-scope": [0],</span><br><span class="line">    "react/forbid-prop-types": [0],</span><br><span class="line">    "react/jsx-filename-extension": [1, &#123; "extensions": [".js"] &#125;],</span><br><span class="line">    "global-require": [1],</span><br><span class="line">    "import/prefer-default-export": [0],</span><br><span class="line">    "react/jsx-no-bind": [0],</span><br><span class="line">    "react/prop-types": [0],</span><br><span class="line">    "react/prefer-stateless-function": [0],</span><br><span class="line">    "no-else-return": [0],</span><br><span class="line">    "no-restricted-syntax": [0],</span><br><span class="line">    "import/no-extraneous-dependencies": [0],</span><br><span class="line">    "no-use-before-define": [0],</span><br><span class="line">    "jsx-a11y/no-static-element-interactions": [0],</span><br><span class="line">    "no-nested-ternary": [0],</span><br><span class="line">    "arrow-body-style": [0],</span><br><span class="line">    "import/extensions": [0],</span><br><span class="line">    "no-bitwise": [0],</span><br><span class="line">    "no-cond-assign": [0],</span><br><span class="line">    "import/no-unresolved": [0],</span><br><span class="line">    "require-yield": [1],</span><br><span class="line">    "no-param-reassign": [0],</span><br><span class="line">    "no-shadow": [0],</span><br><span class="line">    "no-underscore-dangle": [0],</span><br><span class="line">    "spaced-comment": [0],</span><br><span class="line">    "indent": [0],</span><br><span class="line">    "quotes": [0],</span><br><span class="line">    "func-names": [0],</span><br><span class="line">    "arrow-parens": [0],</span><br><span class="line">    "space-before-function-paren": [0],</span><br><span class="line">    "no-useless-escape": [0],</span><br><span class="line">    "object-curly-newline": [0],</span><br><span class="line">    "function-paren-newline": [0],</span><br><span class="line">    "class-methods-use-this": [0],</span><br><span class="line">    "no-new": [0],</span><br><span class="line">    "import/newline-after-import": [0],</span><br><span class="line">    "no-console": [0]</span><br><span class="line">  &#125;, //规则覆盖</span><br><span class="line">  "parserOptions": &#123;</span><br><span class="line">    "ecmaFeatures": &#123;</span><br><span class="line">      "experimentalObjectRestSpread": true</span><br><span class="line">    &#125; //启用对实验对象休息/传播属性的支持,弃用</span><br><span class="line">  &#125; //指定解析器选项</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="Typescript"><a href="#Typescript" class="headerlink" title="Typescript"></a>Typescript</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="string">"compilerOptions"</span>: &#123;</span><br><span class="line">    <span class="string">"target"</span>: <span class="string">"esnext"</span>,<span class="comment">//指定ECMAScript的目标版本,"ESNext"目标是最新支持的ES提议功能。</span></span><br><span class="line">    <span class="string">"moduleResolution"</span>: <span class="string">"node"</span>,<span class="comment">//确定如何解决模块。</span></span><br><span class="line">    <span class="string">"jsx"</span>: <span class="string">"preserve"</span>,<span class="comment">//在.tsx文件中支持JSX</span></span><br><span class="line">    <span class="string">"esModuleInterop"</span>: <span class="literal">true</span><span class="comment">//发布__importStar和生成器__importDefault兼容性，用于运行时babel生态系统兼容性，并支持--allowSyntheticDefaultImports类型系统兼容性。</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="scripts-文件夹"><a href="#scripts-文件夹" class="headerlink" title="scripts 文件夹"></a>scripts 文件夹</h3><h4 id="build-js"><a href="#build-js" class="headerlink" title="build.js"></a>build.js</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">child_process 模块提供了以与 popen(3) 类似但不相同的方式衍生子进程的功能。</span></span><br><span class="line"><span class="comment">child_process.fork():衍生一个新的 Node.js 进程，并通过建立 IPC 通信通道来调用指定的模块，该通道允许在父进程与子进程之间发送消息。</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">const</span> &#123; fork &#125; = <span class="built_in">require</span>(<span class="string">'child_process'</span>);</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">path 模块提供用于处理文件路径和目录路径的实用工具。</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">const</span> &#123; join &#125; = <span class="built_in">require</span>(<span class="string">'path'</span>);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">runUmiTools</span>(<span class="params">...args</span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log([<span class="string">'&gt;&gt; umi-tools'</span>, ...args].join(<span class="string">' '</span>));</span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">  child_process.fork(modulePath[, args][, options])</span></span><br><span class="line"><span class="comment">  modulePath &lt;string&gt; 要在子进程中运行的模块。</span></span><br><span class="line"><span class="comment">  args &lt;string[]&gt; 字符串参数的列表。</span></span><br><span class="line"><span class="comment">  options &lt;Object&gt;</span></span><br><span class="line"><span class="comment">    stdio &lt;Array&gt; | &lt;string&gt; 参阅 child_process.spawn() 的 stdio。当提供此选项时，则它覆盖 silent 选项。如果使用了数组变量，则它必须包含一个值为 'ipc' 的元素，否则会抛出错误。例如 [0, 1, 2, 'ipc']。</span></span><br><span class="line"><span class="comment">    cwd &lt;string&gt; 子进程的当前工作目录。</span></span><br><span class="line"><span class="comment">  返回: &lt;ChildProcess&gt;</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">  path.join([...paths])</span></span><br><span class="line"><span class="comment">  ...paths &lt;string&gt; 路径片段的序列。</span></span><br><span class="line"><span class="comment">  返回: &lt;string&gt;</span></span><br><span class="line"><span class="comment">  path.join() 方法使用平台特定的分隔符作为定界符将所有给定的 path 片段连接在一起，然后规范化生成的路径。</span></span><br><span class="line"><span class="comment">  零长度的 path 片段会被忽略。 如果连接的路径字符串是零长度的字符串，则返回 '.'，表示当前工作目录。</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">   process.cwd() 方法返回 Node.js 进程的当前工作目录。</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line">  <span class="keyword">return</span> fork(join(process.cwd(), <span class="string">'node_modules/.bin/umi-tools'</span>), [...args].concat(process.argv.slice(<span class="number">2</span>)), &#123;</span><br><span class="line">    stdio: <span class="string">'inherit'</span>,</span><br><span class="line">    cwd: process.cwd()</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> cp = runUmiTools(<span class="string">'build'</span>);</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">'error' 事件</span></span><br><span class="line"><span class="comment">err &lt;Error&gt; 错误对象。</span></span><br><span class="line"><span class="comment">当出现以下情况时触发 'error' 事件：</span></span><br><span class="line"><span class="comment">1.无法衍生进程；</span></span><br><span class="line"><span class="comment">2.无法杀死进程；</span></span><br><span class="line"><span class="comment">3.向子进程发送信息失败。</span></span><br><span class="line"><span class="comment">发生错误后，'exit' 事件可能会也可能不会触发。如果同时监听了 'exit' 和 'error' 事件，可能会多次调用处理函数。</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">cp.on(<span class="string">'error'</span>, err =&gt; &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(err);</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">'message' 事件</span></span><br><span class="line"><span class="comment">  message &lt;Object&gt; JSON 对象或原始值。</span></span><br><span class="line"><span class="comment">  sendHandle &lt;Handle&gt; net.Socket 或 net.Server 对象，或 undefined。</span></span><br><span class="line"><span class="comment">当子进程使用 process.send() 发送消息时触发。</span></span><br><span class="line"><span class="comment">消息通过序列化和解析传递，收到的消息可能跟发送的不完全一样。</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">cp.on(<span class="string">'message'</span>, message =&gt; &#123;</span><br><span class="line">  <span class="keyword">if</span> (message === <span class="string">'BUILD_COMPLETE'</span>) &#123;</span><br><span class="line">    runUmiTools(<span class="string">'rollup'</span>, <span class="string">'-g'</span>, <span class="string">'dva:dva,antd:antd'</span>);</span><br><span class="line">  &#125; <span class="comment">//构建完成打包</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<h4 id="publish-js"><a href="#publish-js" class="headerlink" title="publish.js"></a>publish.js</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">ShellJS是 Node.js API之上的Unix shell 命令的可移植（Windows / Linux / OS X）实现。您可以使用它来消除shell脚本对Unix的依赖性，同时仍保留其熟悉且功能强大的命令。您也可以在全局安装它，这样您就可以从Node项目外部运行它- 告别那些粗糙的Bash脚本！</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">const</span> shell = <span class="built_in">require</span>(<span class="string">'shelljs'</span>);</span><br><span class="line"><span class="keyword">const</span> &#123; join &#125; = <span class="built_in">require</span>(<span class="string">'path'</span>);</span><br><span class="line"><span class="keyword">const</span> &#123; fork &#125; = <span class="built_in">require</span>(<span class="string">'child_process'</span>);</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">shell.exec(command [, options] [, callback])</span></span><br><span class="line"><span class="comment">执行命令</span></span><br><span class="line"><span class="comment">options：</span></span><br><span class="line"><span class="comment">  async：异步执行。如果提供了回调，则true无论传递的值如何（默认值:)，都将设置为回调  false。</span></span><br><span class="line"><span class="comment">  silent：不要将程序输出回显到控制台（默认值:) false。</span></span><br><span class="line"><span class="comment">  encoding：要使用的字符编码。影响返回到stdout和stderr的值，以及未处于静默模式时写入stdout和stderr的值（默认值:) 'utf8'。</span></span><br><span class="line"><span class="comment">以及Node.js可用的任何选项 child_process.exec()</span></span><br><span class="line"><span class="comment">除非另有说明，否则command同步执行给定的给定。</span></span><br><span class="line"><span class="comment">在同步模式下，这将返回ShellString。否则，这将返回子进程对象，并callback接收参数(code, stdout, stderr)。</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">if</span> (!shell.exec(<span class="string">'npm config get registry'</span>).stdout.includes(<span class="string">'https://registry.npmjs.org/'</span>)) &#123;</span><br><span class="line">  <span class="built_in">console</span>.error(<span class="string">'Failed: set npm registry to https://registry.npmjs.org/ first'</span>);</span><br><span class="line">  process.exit(<span class="number">1</span>); <span class="comment">//退出进程</span></span><br><span class="line">&#125; <span class="comment">//判断当前npm镜像源是否为npm官方源，不是则失败提示请设置镜像源</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> cwd = process.cwd();</span><br><span class="line"><span class="keyword">const</span> ret = shell.exec(<span class="string">'./node_modules/.bin/lerna updated'</span>).stdout; <span class="comment">//运行lerna updated时的输出</span></span><br><span class="line"><span class="keyword">const</span> updatedRepos = ret</span><br><span class="line">  .split(<span class="string">'\n'</span>)</span><br><span class="line">  .map(<span class="function"><span class="params">line</span> =&gt;</span> line.replace(<span class="string">'- '</span>, <span class="string">''</span>))</span><br><span class="line">  .filter(<span class="function"><span class="params">line</span> =&gt;</span> line !== <span class="string">''</span>); <span class="comment">//筛选出需要更新的仓库</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (updatedRepos.length === <span class="number">0</span>) &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'No package is updated.'</span>);</span><br><span class="line">  process.exit(<span class="number">0</span>);</span><br><span class="line">&#125; <span class="comment">//没有需要更新仓库的情况</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> &#123; <span class="attr">code</span>: buildCode &#125; = shell.exec(<span class="string">'npm run build'</span>); <span class="comment">//执行构建</span></span><br><span class="line"><span class="keyword">if</span> (buildCode === <span class="number">1</span>) &#123;</span><br><span class="line">  <span class="built_in">console</span>.error(<span class="string">'Failed: npm run build'</span>);</span><br><span class="line">  process.exit(<span class="number">1</span>);</span><br><span class="line">&#125; <span class="comment">//构建失败情况</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> &#123; <span class="attr">code</span>: uiBuildCode &#125; = shell.exec(<span class="string">'npm run ui:build'</span>); <span class="comment">//执行ui构建</span></span><br><span class="line"><span class="keyword">if</span> (uiBuildCode === <span class="number">1</span>) &#123;</span><br><span class="line">  <span class="built_in">console</span>.error(<span class="string">'Failed: npm run ui:build'</span>);</span><br><span class="line">  process.exit(<span class="number">1</span>);</span><br><span class="line">&#125; <span class="comment">//ui构建失败情况</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> cp = fork(join(process.cwd(), <span class="string">'node_modules/.bin/lerna'</span>), [<span class="string">'version'</span>].concat(process.argv.slice(<span class="number">2</span>)), &#123;</span><br><span class="line">  stdio: <span class="string">'inherit'</span>,</span><br><span class="line">  cwd: process.cwd()</span><br><span class="line">&#125;);</span><br><span class="line">cp.on(<span class="string">'error'</span>, err =&gt; &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(err);</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">code &lt;number&gt; 子进程的退出码。</span></span><br><span class="line"><span class="comment">signal &lt;string&gt; 终止子进程的信号。</span></span><br><span class="line"><span class="comment">当子进程的 stdio 流被关闭时触发。 与 'exit' 事件的区别是，多个进程可能共享同一 stdio 流。</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">cp.on(<span class="string">'close'</span>, code =&gt; &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'code'</span>, code);</span><br><span class="line">  <span class="keyword">if</span> (code === <span class="number">1</span>) &#123;</span><br><span class="line">    <span class="built_in">console</span>.error(<span class="string">'Failed: lerna publish'</span>);</span><br><span class="line">    process.exit(<span class="number">1</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  publishToNpm();</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">publishToNpm</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">`repos to publish: <span class="subst">$&#123;updatedRepos.join(<span class="string">', '</span>)&#125;</span>`</span>);</span><br><span class="line">  updatedRepos.forEach(<span class="function"><span class="params">repo</span> =&gt;</span> &#123;</span><br><span class="line">    shell.cd(join(cwd, <span class="string">'packages'</span>, repo));</span><br><span class="line">    <span class="keyword">const</span> &#123; version &#125; = <span class="built_in">require</span>(join(cwd, <span class="string">'packages'</span>, repo, <span class="string">'package.json'</span>));</span><br><span class="line">    <span class="keyword">if</span> (version.includes(<span class="string">'-rc.'</span>) || version.includes(<span class="string">'-beta.'</span>) || version.includes(<span class="string">'-alpha.'</span>)) &#123;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">`[<span class="subst">$&#123;repo&#125;</span>] npm publish --tag next`</span>);</span><br><span class="line">      shell.exec(<span class="string">`npm publish --tag next`</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">`[<span class="subst">$&#123;repo&#125;</span>] npm publish`</span>);</span><br><span class="line">      shell.exec(<span class="string">`npm publish`</span>);</span><br><span class="line">    &#125; <span class="comment">//版本包含-rc.-beta.-alpha.字眼更新标签，否则直接发布</span></span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="startDevServers-js"><a href="#startDevServers-js" class="headerlink" title="startDevServers.js"></a>startDevServers.js</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> &#123; fork &#125; = <span class="built_in">require</span>(<span class="string">'child_process'</span>);</span><br><span class="line"><span class="keyword">const</span> &#123; join, dirname &#125; = <span class="built_in">require</span>(<span class="string">'path'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> DEV_SCRIPT = join(__dirname, <span class="string">'../packages/umi/bin/umi.js'</span>);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">startDevServer</span>(<span class="params">opts = &#123;&#125;</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> &#123; port, cwd &#125; = opts;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function"><span class="params">resolve</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> child = fork(DEV_SCRIPT, [<span class="string">'dev'</span>, <span class="string">'--port'</span>, port, <span class="string">'--cwd'</span>, cwd], &#123;</span><br><span class="line">      env: &#123;</span><br><span class="line">        ...process.env,</span><br><span class="line">        CLEAR_CONSOLE: <span class="string">'none'</span>,</span><br><span class="line">        BROWSER: <span class="string">'none'</span>,</span><br><span class="line">        UMI_DIR: dirname(<span class="built_in">require</span>.resolve(<span class="string">'../packages/umi/package'</span>))</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    child.on(<span class="string">'message'</span>, args =&gt; &#123;</span><br><span class="line">      <span class="keyword">if</span> (args.type === <span class="string">'DONE'</span>) &#123;</span><br><span class="line">        resolve(child);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">start</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> devServers = [</span><br><span class="line">    [<span class="number">12341</span>, <span class="string">'../packages/umi/test/fixtures/e2e/normal'</span>],</span><br><span class="line">    [<span class="number">12342</span>, <span class="string">'../packages/umi/test/fixtures/e2e/hashHistory'</span>],</span><br><span class="line">    [<span class="number">12351</span>, <span class="string">'../packages/umi-plugin-react/test/normal'</span>],</span><br><span class="line">    [<span class="number">12352</span>, <span class="string">'../packages/umi-plugin-react/test/with-dva'</span>],</span><br><span class="line">    [<span class="number">12353</span>, <span class="string">'../packages/umi-plugin-react/test/pwa'</span>]</span><br><span class="line">  ];</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">Promise</span>.all(</span><br><span class="line">    devServers.map(<span class="function">(<span class="params">[port, cwd]</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> startDevServer(&#123; port, <span class="attr">cwd</span>: join(__dirname, cwd) &#125;);</span><br><span class="line">    &#125;)</span><br><span class="line">  );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = start;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="built_in">require</span>.main === <span class="built_in">module</span>) &#123;</span><br><span class="line">  start()</span><br><span class="line">    .then(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">'All dev servers are started.'</span>);</span><br><span class="line">    &#125;)</span><br><span class="line">    .catch(<span class="function"><span class="params">e</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="built_in">console</span>.log(e);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="test-js"><a href="#test-js" class="headerlink" title="test.js"></a>test.js</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">child_process.spawn() 方法异步地衍生子进程，且不阻塞 Node.js 事件循环。 child_process.spawnSync() 方法则以同步的方式提供等效功能，但会阻止事件循环直到衍生的进程退出或终止。</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">const</span> &#123; spawn &#125; = <span class="built_in">require</span>(<span class="string">'child_process'</span>);</span><br><span class="line"><span class="keyword">const</span> startDevServers = <span class="built_in">require</span>(<span class="string">'./startDevServers'</span>);</span><br><span class="line"></span><br><span class="line">startDevServers()</span><br><span class="line">  .then(<span class="function"><span class="params">devServers</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> testCmd = spawn(<span class="regexp">/^win/</span>.test(process.platform) ? <span class="string">'npm.cmd'</span> : <span class="string">'npm'</span>, [<span class="string">'run'</span>, <span class="string">'test:coverage'</span>], &#123;</span><br><span class="line">      stdio: <span class="string">'inherit'</span></span><br><span class="line">    &#125;);</span><br><span class="line">    testCmd.on(<span class="string">'exit'</span>, code =&gt; &#123;</span><br><span class="line">      devServers.forEach(<span class="function"><span class="params">devServer</span> =&gt;</span> devServer &amp;&amp; devServer.kill(<span class="string">'SIGINT'</span>));</span><br><span class="line">      process.exit(code);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;)</span><br><span class="line">  .catch(<span class="function"><span class="params">e</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(e);</span><br><span class="line">  &#125;);</span><br></pre></td></tr></table></figure>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><h4 id="2019-3-31"><a href="#2019-3-31" class="headerlink" title="2019/3/31"></a>2019/3/31</h4><p>通过了解 umi 的源码知道了很多有意思的东西：npm 包发布、通过 lerna 来管理包、使用 Travis 持续集成项目、EditorConfig 来保证不同编辑器风格一致、ESLint 保证代码风格一致、Jest 测试保证代码可靠性、lint-staged 和 husky 阻止代码提交（最开始在 ant design pro 有遇到），shelljs 执行脚本命令。</p>
<h3 id="demo-地址"><a href="#demo-地址" class="headerlink" title="demo 地址"></a>demo 地址</h3><p><a href="https://github.com/ShawDanon/txp" target="_blank" rel="noopener">准备用来存些常用库的仓库</a></p>
<h3 id="参考一"><a href="#参考一" class="headerlink" title="参考一"></a>参考一</h3><p><a href="https://juejin.im/post/5c26c1b65188252dcb312ad6#heading-0" target="_blank" rel="noopener">创建并发布一个小而美的 npm 包，没你想的那么难！</a><br><a href="https://juejin.im/post/5a989fb451882555731b88c2" target="_blank" rel="noopener">lerna 管理前端 packages 的最佳实践</a><br><a href="https://github.com/lerna/lerna/#getting-started" target="_blank" rel="noopener">lerna 文档</a><br><a href="https://github.com/lerna/lerna-changelog" target="_blank" rel="noopener">lerna-changelog 文档</a><br><a href="https://efe.baidu.com/blog/front-end-continuous-integration-tools/" target="_blank" rel="noopener">前端开源项目持续集成三剑客</a><br><a href="https://editorconfig.org/" target="_blank" rel="noopener">editorconfig</a><br><a href="https://eslint.org/docs/user-guide/getting-started" target="_blank" rel="noopener">eslint</a><br><a href="http://nodejs.cn/api/" target="_blank" rel="noopener">Node.js 中文网</a><br><a href="http://documentup.com/shelljs/shelljs" target="_blank" rel="noopener">shelljs</a></p>
<h2 id="学习-UMI（二）"><a href="#学习-UMI（二）" class="headerlink" title="学习 UMI（二）"></a>学习 UMI（二）</h2><p><a href="mailto:umi@2.6.17" target="_blank" rel="noopener">umi@2.6.17</a><br>正式开始看源码了</p>
<h3 id="packages-umi"><a href="#packages-umi" class="headerlink" title="packages/umi"></a>packages/umi</h3><h4 id="重要的"><a href="#重要的" class="headerlink" title="重要的"></a>重要的</h4><h5 id="packages-umi-package-json"><a href="#packages-umi-package-json" class="headerlink" title="packages/umi/package.json"></a>packages/umi/package.json</h5><p>先来看看 package.json 文件。</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"name"</span>: <span class="string">"umi"</span>,</span><br><span class="line">  <span class="attr">"version"</span>: <span class="string">"2.6.16"</span>,</span><br><span class="line">  <span class="attr">"description"</span>: <span class="string">"Pluggable enterprise-level react application framework."</span>,</span><br><span class="line">  <span class="attr">"dependencies"</span>: &#123;</span><br><span class="line">    "@babel/core": "7.2.2", //babel核心包</span><br><span class="line">    "@babel/runtime": "7.3.0", //一个包含Babel模块化运行时助手和一个版本的库</span><br><span class="line">    "@types/react": "16.x", //react</span><br><span class="line">    "@types/react-router-dom": "4.x", //react路由</span><br><span class="line">    "babel-preset-umi": "1.4.1", //云谦的babel预设</span><br><span class="line">    "debug": "4.1.0", //一个微小的JavaScript调试工具，以Node.js核心的调试技术为模型。适用于Node.js和Web浏览器。</span><br><span class="line">    "dotenv": "6.2.0", //Dotenv是一个零依赖模块，可以将.env文件中的环境变量加载到process.env。在与代码分开的环境中存储配置基于The Twelve-Factor App方法。</span><br><span class="line">    "is-windows": "1.0.2", //如果平台是windows，则返回true。UMD模块，适用于node.js，commonjs，浏览器，AMD，电子等。</span><br><span class="line">    "lodash": "4.17.11", //一个现代JavaScript实用程序库，提供模块化，性能和附加功能。深拷贝用过</span><br><span class="line">    "react-loadable": "5.5.0", //用于加载具有动态导入的组件的更高阶组件。</span><br><span class="line">    "resolve-cwd": "2.0.0", //解析模块的路径，require.resolve()但是从当前工作目录中解析</span><br><span class="line">    "semver": "5.6.0", //节点的semver解析器，语义化版本</span><br><span class="line">    "signale": "1.3.0", //可记录和可配置到核心，signale可用于记录目的，状态报告，以及处理其他节点模块和应用程序的输出呈现过程。</span><br><span class="line">    "umi-build-dev": "1.8.3", //未有readme文件具体功能暂时不知</span><br><span class="line">    "umi-utils": "1.4.1", //工具类</span><br><span class="line">    "update-notifier": "2.5.0", //更新CLI应用程序的通知</span><br><span class="line">    "yargs-parser": "13.0.0" //Yargs通过解析参数和生成优雅的用户界面来帮助您构建交互式命令行工具。</span><br><span class="line">  &#125;, //依赖包</span><br><span class="line">  "module": "index.js",</span><br><span class="line">  "sideEffects": ["./lib/renderRoutes.js"],</span><br><span class="line">  "bin": &#123;</span><br><span class="line">    "umi": "./bin/umi.js"</span><br><span class="line">  &#125;, //很多软件包都有一个或多个可以安装到PATH中的可执行文件。</span><br><span class="line">  "license": "MIT",</span><br><span class="line">  "repository": &#123;</span><br><span class="line">    "type": "git",</span><br><span class="line">    "url": "https://github.com/umijs/umi/tree/master/packages/umi"</span><br><span class="line">  &#125;,</span><br><span class="line">  "homepage": "https://github.com/umijs/umi/tree/master/packages/umi",</span><br><span class="line">  "authors": ["chencheng &lt;sorrycc@gmail.com&gt; (https://github.com/sorrycc)"],</span><br><span class="line">  "bugs": &#123;</span><br><span class="line">    "url": "https://github.com/umijs/umi/issues"</span><br><span class="line">  &#125;,</span><br><span class="line">  "files": [</span><br><span class="line">    "lib",</span><br><span class="line">    "src",</span><br><span class="line">    "bin",</span><br><span class="line">    "index.js",</span><br><span class="line">    "index.d.ts",</span><br><span class="line">    "babel.js",</span><br><span class="line">    "dynamic.d.ts",</span><br><span class="line">    "link.d.ts",</span><br><span class="line">    "navlink.d.ts",</span><br><span class="line">    "prompt.d.ts",</span><br><span class="line">    "redirect.d.ts",</span><br><span class="line">    "router.d.ts",</span><br><span class="line">    "withRouter.d.ts",</span><br><span class="line">    <span class="string">"routerTypes.d.ts"</span></span><br><span class="line">  ], //可选files字段是一个文件模式数组，描述了将软件包作为依赖项安装时要包含的条目。</span><br><span class="line">  "umiTools": &#123;</span><br><span class="line">    "browserFiles": [</span><br><span class="line">      "src/createHistory.js",</span><br><span class="line">      "src/dynamic.js",</span><br><span class="line">      "src/link.js",</span><br><span class="line">      "src/navlink.js",</span><br><span class="line">      "src/prompt.js",</span><br><span class="line">      "src/redirect.js",</span><br><span class="line">      "src/renderRoutes.js",</span><br><span class="line">      "src/Route.js",</span><br><span class="line">      "src/router.js",</span><br><span class="line">      "src/runtimePlugin.js",</span><br><span class="line">      "src/utils.js",</span><br><span class="line">      <span class="string">"src/withRouter.js"</span></span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="提供接口相关的文件"><a href="#提供接口相关的文件" class="headerlink" title="提供接口相关的文件"></a>提供接口相关的文件</h4><h5 id="packages-umi-index-js"><a href="#packages-umi-index-js" class="headerlink" title="packages/umi/index.js"></a>packages/umi/index.js</h5><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> &#123; <span class="keyword">default</span> <span class="keyword">as</span> Link &#125; <span class="keyword">from</span> <span class="string">'./lib/link'</span>;</span><br><span class="line"><span class="keyword">export</span> &#123; <span class="keyword">default</span> <span class="keyword">as</span> NavLink &#125; <span class="keyword">from</span> <span class="string">'./lib/navlink'</span>;</span><br><span class="line"><span class="keyword">export</span> &#123; <span class="keyword">default</span> <span class="keyword">as</span> Redirect &#125; <span class="keyword">from</span> <span class="string">'./lib/redirect'</span>;</span><br><span class="line"><span class="keyword">export</span> &#123; <span class="keyword">default</span> <span class="keyword">as</span> dynamic &#125; <span class="keyword">from</span> <span class="string">'./lib/dynamic'</span>;</span><br><span class="line"><span class="keyword">export</span> &#123; <span class="keyword">default</span> <span class="keyword">as</span> router &#125; <span class="keyword">from</span> <span class="string">'./lib/router'</span>;</span><br><span class="line"><span class="keyword">export</span> &#123; <span class="keyword">default</span> <span class="keyword">as</span> withRouter &#125; <span class="keyword">from</span> <span class="string">'./lib/withRouter'</span>;</span><br><span class="line"><span class="keyword">export</span> &#123; <span class="keyword">default</span> <span class="keyword">as</span> Route &#125; <span class="keyword">from</span> <span class="string">'./lib/Route'</span>;</span><br></pre></td></tr></table></figure>
<p>umi 输出的 api 对应<a href="https://umijs.org/zh/api/" target="_blank" rel="noopener">官方文档</a>。</p>
<h5 id="packages-umi-link-js"><a href="#packages-umi-link-js" class="headerlink" title="packages/umi/link.js"></a>packages/umi/link.js</h5><p>link 组件直接使用 react-router 的 link 组件</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; Link &#125; <span class="keyword">from</span> <span class="string">'react-router-dom'</span>;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> Link;</span><br></pre></td></tr></table></figure>
<h5 id="packages-umi-NavLink-js"><a href="#packages-umi-NavLink-js" class="headerlink" title="packages/umi/NavLink.js"></a>packages/umi/NavLink.js</h5><p>NavLink 组件直接使用 react-router 的 NavLink 组件</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; NavLink &#125; <span class="keyword">from</span> <span class="string">'react-router-dom'</span>;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> NavLink;</span><br></pre></td></tr></table></figure>
<h5 id="packages-umi-Redirect-js"><a href="#packages-umi-Redirect-js" class="headerlink" title="packages/umi/Redirect.js"></a>packages/umi/Redirect.js</h5><p>Redirect 组件直接使用 react-router 的 Redirect 组件</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; Redirect &#125; <span class="keyword">from</span> <span class="string">'react-router-dom'</span>;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> Redirect;</span><br></pre></td></tr></table></figure>
<h5 id="packages-umi-router-js"><a href="#packages-umi-router-js" class="headerlink" title="packages/umi/router.js"></a>packages/umi/router.js</h5><p>js 路由操作文件</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* global window */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">push</span>(<span class="params">...args</span>) </span>&#123;</span><br><span class="line">  <span class="built_in">window</span>.g_history.push(...args);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">replace</span>(<span class="params">...args</span>) </span>&#123;</span><br><span class="line">  <span class="built_in">window</span>.g_history.replace(...args);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">go</span>(<span class="params">...args</span>) </span>&#123;</span><br><span class="line">  <span class="built_in">window</span>.g_history.go(...args);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">goBack</span>(<span class="params">...args</span>) </span>&#123;</span><br><span class="line">  <span class="built_in">window</span>.g_history.goBack(...args);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">goForward</span>(<span class="params">...args</span>) </span>&#123;</span><br><span class="line">  <span class="built_in">window</span>.g_history.goForward(...args);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">  push,</span><br><span class="line">  replace,</span><br><span class="line">  go,</span><br><span class="line">  goBack,</span><br><span class="line">  goForward</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h5 id="packages-umi-withRouter-js"><a href="#packages-umi-withRouter-js" class="headerlink" title="packages/umi/withRouter.js"></a>packages/umi/withRouter.js</h5><p>withRouter 组件直接使用 react-router 的 withRouter 组件</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; withRouter &#125; <span class="keyword">from</span> <span class="string">'react-router-dom'</span>;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> withRouter;</span><br></pre></td></tr></table></figure>
<h5 id="packages-umi-Route-js"><a href="#packages-umi-Route-js" class="headerlink" title="packages/umi/Route.js"></a>packages/umi/Route.js</h5><p>Route 组件直接使用 react-router 的 Route 组件</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; Route &#125; <span class="keyword">from</span> <span class="string">'react-router-dom'</span>;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> Route;</span><br></pre></td></tr></table></figure>
<h5 id="packages-umi-dynamic-js"><a href="#packages-umi-dynamic-js" class="headerlink" title="packages/umi/dynamic.js"></a>packages/umi/dynamic.js</h5><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React <span class="keyword">from</span> <span class="string">'react'</span>;</span><br><span class="line"><span class="keyword">import</span> Loadable <span class="keyword">from</span> <span class="string">'react-loadable'</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Thanks to next.js</span></span><br><span class="line"><span class="comment">// ref: https://github.com/zeit/next.js/blob/canary/lib/dynamic.js</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="function"><span class="keyword">function</span>(<span class="params">dynamicOptions, options</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> loadableFn = Loadable;</span><br><span class="line">  <span class="keyword">let</span> loadableOptions = &#123;</span><br><span class="line">    loading: <span class="function">(<span class="params">&#123; error, isLoading &#125;</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (process.env.NODE_ENV === <span class="string">'development'</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (isLoading) &#123;</span><br><span class="line">          <span class="keyword">return</span> <span class="xml"><span class="tag">&lt;<span class="name">p</span>&gt;</span>loading...<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (error) &#123;</span><br><span class="line">          <span class="keyword">return</span> (</span><br><span class="line">            &lt;p&gt;</span><br><span class="line">              &#123;error.message&#125;</span><br><span class="line">              &lt;br /&gt;</span><br><span class="line">              &#123;error.stack&#125;</span><br><span class="line">            &lt;<span class="regexp">/p&gt;</span></span><br><span class="line"><span class="regexp">          );</span></span><br><span class="line"><span class="regexp">        &#125;</span></span><br><span class="line"><span class="regexp">      &#125;</span></span><br><span class="line"><span class="regexp">      return &lt;p&gt;loading...&lt;/</span>p&gt;;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Support for direct import(),</span></span><br><span class="line">  <span class="comment">// eg: dynamic(import('../hello-world'))</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> dynamicOptions.then === <span class="string">'function'</span>) &#123;</span><br><span class="line">    loadableOptions.loader = <span class="function"><span class="params">()</span> =&gt;</span> dynamicOptions;</span><br><span class="line">    <span class="comment">// Support for having first argument being options,</span></span><br><span class="line">    <span class="comment">// eg: dynamic(&#123;loader: import('../hello-world')&#125;)</span></span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">typeof</span> dynamicOptions === <span class="string">'object'</span>) &#123;</span><br><span class="line">    loadableOptions = &#123; ...loadableOptions, ...dynamicOptions &#125;;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Support for passing options,</span></span><br><span class="line">  <span class="comment">// eg: dynamic(import('../hello-world'), &#123;loading: () =&gt; &lt;p&gt;Loading something&lt;/p&gt;&#125;)</span></span><br><span class="line">  loadableOptions = &#123; ...loadableOptions, ...options &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Support for `render` when using a mapping,</span></span><br><span class="line">  <span class="comment">// eg: `dynamic(&#123; modules: () =&gt; &#123;return &#123;HelloWorld: import('../hello-world')&#125;, render(props, loaded) &#123;&#125; &#125; &#125;)</span></span><br><span class="line">  <span class="keyword">if</span> (dynamicOptions.render) &#123;</span><br><span class="line">    loadableOptions.render = <span class="function">(<span class="params">loaded, props</span>) =&gt;</span> dynamicOptions.render(props, loaded);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Support for `modules` when using a mapping,</span></span><br><span class="line">  <span class="comment">// eg: `dynamic(&#123; modules: () =&gt; &#123;return &#123;HelloWorld: import('../hello-world')&#125;, render(props, loaded) &#123;&#125; &#125; &#125;)</span></span><br><span class="line">  <span class="keyword">if</span> (dynamicOptions.modules) &#123;</span><br><span class="line">    loadableFn = Loadable.Map;</span><br><span class="line">    <span class="keyword">const</span> loadModules = &#123;&#125;;</span><br><span class="line">    <span class="keyword">const</span> modules = dynamicOptions.modules();</span><br><span class="line">    <span class="built_in">Object</span>.keys(modules).forEach(<span class="function"><span class="params">key</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> value = modules[key];</span><br><span class="line">      <span class="keyword">if</span> (<span class="keyword">typeof</span> value.then === <span class="string">'function'</span>) &#123;</span><br><span class="line">        loadModules[key] = <span class="function"><span class="params">()</span> =&gt;</span> value.then(<span class="function"><span class="params">mod</span> =&gt;</span> mod.default || mod);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      loadModules[key] = value;</span><br><span class="line">    &#125;);</span><br><span class="line">    loadableOptions.loader = loadModules;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> loadableFn(loadableOptions);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="命令相关的文件"><a href="#命令相关的文件" class="headerlink" title="命令相关的文件"></a>命令相关的文件</h4><h5 id="packages-umi-bin-umi-js"><a href="#packages-umi-bin-umi-js" class="headerlink" title="packages/umi/bin/umi.js"></a>packages/umi/bin/umi.js</h5><p>umi 命令的入口文件，<code>umi [option]</code>就会执行这个文件了。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/usr/bin/env node</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> resolveCwd = <span class="built_in">require</span>(<span class="string">'resolve-cwd'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> localCLI = resolveCwd.silent(<span class="string">'umi/bin/umi'</span>); <span class="comment">//获取模块路径，测试结果为null</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (localCLI &amp;&amp; localCLI !== __filename) &#123;</span><br><span class="line">  <span class="keyword">const</span> debug = <span class="built_in">require</span>(<span class="string">'debug'</span>)(<span class="string">'umi'</span>);</span><br><span class="line">  debug(<span class="string">'Using local install of umi'</span>);</span><br><span class="line">  <span class="built_in">require</span>(localCLI);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">  <span class="built_in">require</span>(<span class="string">'../lib/cli'</span>);</span><br><span class="line">&#125; <span class="comment">//执行cli</span></span><br></pre></td></tr></table></figure>
<h5 id="packages-umi-src-cli-js"><a href="#packages-umi-src-cli-js" class="headerlink" title="packages/umi/src/cli.js"></a>packages/umi/src/cli.js</h5><p>从入口文件来到具体命令处理的文件</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; dirname &#125; <span class="keyword">from</span> <span class="string">'path'</span>;</span><br><span class="line"><span class="keyword">import</span> yParser <span class="keyword">from</span> <span class="string">'yargs-parser'</span>;</span><br><span class="line"><span class="keyword">import</span> signale <span class="keyword">from</span> <span class="string">'signale'</span>;</span><br><span class="line"><span class="keyword">import</span> semver <span class="keyword">from</span> <span class="string">'semver'</span>;</span><br><span class="line"><span class="keyword">import</span> buildDevOpts <span class="keyword">from</span> <span class="string">'./buildDevOpts'</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//process.argv属性返回一个数组，其中包含当启动 Node.js 进程时传入的命令行参数。</span></span><br><span class="line"><span class="keyword">const</span> script = process.argv[<span class="number">2</span>]; <span class="comment">//获取第一个可选参数（数组前两个是路径）</span></span><br><span class="line"><span class="keyword">const</span> args = yParser(process.argv.slice(<span class="number">3</span>)); <span class="comment">//获取第一个可选参数之后的参数，转换成对象。如：umi dev -a -name=1，args为&#123;_:[],a:true,name:1&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Node版本检查</span></span><br><span class="line"><span class="keyword">const</span> nodeVersion = process.versions.node; <span class="comment">//node版本号</span></span><br><span class="line"><span class="keyword">if</span> (semver.satisfies(nodeVersion, <span class="string">'&lt;6.5'</span>)) &#123;</span><br><span class="line">  signale.error(<span class="string">`Node version must &gt;= 6.5, but got <span class="subst">$&#123;nodeVersion&#125;</span>`</span>);</span><br><span class="line">  process.exit(<span class="number">1</span>);</span><br><span class="line">&#125; <span class="comment">//版本小于6.5提示node版本大于等于6.5并退出程序</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 进程退出（defer: true ）时通知更新</span></span><br><span class="line"><span class="keyword">const</span> updater = <span class="built_in">require</span>(<span class="string">'update-notifier'</span>);</span><br><span class="line"><span class="keyword">const</span> pkg = <span class="built_in">require</span>(<span class="string">'../package.json'</span>);</span><br><span class="line">updater(&#123; pkg &#125;).notify(&#123; <span class="attr">defer</span>: <span class="literal">true</span> &#125;);</span><br><span class="line"></span><br><span class="line">process.env.UMI_DIR = dirname(<span class="built_in">require</span>.resolve(<span class="string">'../package'</span>)); <span class="comment">//当前包根目录路径</span></span><br><span class="line">process.env.UMI_VERSION = pkg.version; <span class="comment">//当前包版本</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> aliasMap = &#123;</span><br><span class="line">  <span class="string">'-v'</span>: <span class="string">'version'</span>,</span><br><span class="line">  <span class="string">'--version'</span>: <span class="string">'version'</span>,</span><br><span class="line">  <span class="string">'-h'</span>: <span class="string">'help'</span>,</span><br><span class="line">  <span class="string">'--help'</span>: <span class="string">'help'</span></span><br><span class="line">&#125;; <span class="comment">//扩展命令</span></span><br><span class="line"><span class="comment">//如果umi后面有build、dev、test、inspect参数就执行对应scripts文件中的脚本，否则引入umi-build-dev执行</span></span><br><span class="line"><span class="keyword">switch</span> (script) &#123;</span><br><span class="line">  <span class="keyword">case</span> <span class="string">'build'</span>:</span><br><span class="line">  <span class="keyword">case</span> <span class="string">'dev'</span>:</span><br><span class="line">  <span class="keyword">case</span> <span class="string">'test'</span>:</span><br><span class="line">  <span class="keyword">case</span> <span class="string">'inspect'</span>:</span><br><span class="line">    <span class="built_in">require</span>(<span class="string">`./scripts/<span class="subst">$&#123;script&#125;</span>`</span>);</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">  <span class="keyword">default</span>: &#123;</span><br><span class="line">    <span class="keyword">const</span> Service = <span class="built_in">require</span>(<span class="string">'umi-build-dev/lib/Service'</span>).default;</span><br><span class="line">    <span class="keyword">new</span> Service(buildDevOpts(args)).run(aliasMap[script] || script, args);</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="packages-umi-src-buildDevOpts-js"><a href="#packages-umi-src-buildDevOpts-js" class="headerlink" title="packages/umi/src/buildDevOpts.js"></a>packages/umi/src/buildDevOpts.js</h5><p>加载 env 环境并对应平台返回 app 目录路径</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//path.join() 方法使用平台特定的分隔符作为定界符将所有给定的 path 片段连接在一起，然后规范化生成的路径。</span></span><br><span class="line"><span class="comment">//path.isAbsolute() 方法检测 path 是否为绝对路径。</span></span><br><span class="line"><span class="keyword">import</span> &#123; join, isAbsolute &#125; <span class="keyword">from</span> <span class="string">'path'</span>;</span><br><span class="line"><span class="comment">//fs.readFileSync() 同步地读取文件的全部内容。</span></span><br><span class="line"><span class="comment">//fs.existsSync() 通过检查文件系统来测试给定的路径是否存在。</span></span><br><span class="line"><span class="keyword">import</span> &#123; readFileSync, existsSync &#125; <span class="keyword">from</span> <span class="string">'fs'</span>;</span><br><span class="line"><span class="comment">//isWindows 判断是否为Windows平台</span></span><br><span class="line"><span class="keyword">import</span> isWindows <span class="keyword">from</span> <span class="string">'is-windows'</span>;</span><br><span class="line"><span class="comment">//winPath 将Windows反斜杠路径转换为斜杠路径：foo\\bar➔foo/bar</span></span><br><span class="line"><span class="keyword">import</span> &#123; winPath &#125; <span class="keyword">from</span> <span class="string">'umi-utils'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; parse &#125; <span class="keyword">from</span> <span class="string">'dotenv'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="function"><span class="keyword">function</span>(<span class="params">opts = &#123;&#125;</span>) </span>&#123;</span><br><span class="line">  loadDotEnv(); <span class="comment">//加载env环境</span></span><br><span class="line">  <span class="keyword">let</span> cwd = opts.cwd || process.env.APP_ROOT; <span class="comment">//得到将传入路径或者环境设置路径</span></span><br><span class="line">  <span class="keyword">if</span> (cwd) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!isAbsolute(cwd)) &#123;</span><br><span class="line">      cwd = join(process.cwd(), cwd);</span><br><span class="line">    &#125; <span class="comment">//cwd不是绝对路径转换为绝对路径</span></span><br><span class="line">    cwd = winPath(cwd); <span class="comment">//将Windows反斜杠路径转换为斜杠路径：foo\\bar➔foo/ba</span></span><br><span class="line">    <span class="comment">// 原因：webpack 的 include 规则得是 \ 才能判断出是绝对路径</span></span><br><span class="line">    <span class="keyword">if</span> (isWindows()) &#123;</span><br><span class="line">      cwd = cwd.replace(<span class="regexp">/\//g</span>, <span class="string">'\\'</span>);</span><br><span class="line">    &#125; <span class="comment">//如果是Windows平台将/替换为\\ foo/bar➔foo\\bar</span></span><br><span class="line">    <span class="comment">//感觉上面两步怎么不弄成一步来呢</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    cwd</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">loadDotEnv</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="comment">//process.cwd() 方法返回 Node.js 进程的当前工作目录。</span></span><br><span class="line">  <span class="keyword">const</span> baseEnvPath = join(process.cwd(), <span class="string">'.env'</span>); <span class="comment">//获取当前进程目录下.env路径</span></span><br><span class="line">  <span class="keyword">const</span> localEnvPath = <span class="string">`<span class="subst">$&#123;baseEnvPath&#125;</span>.local`</span>; <span class="comment">//获取当前进程目录下.env.local路径</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> loadEnv = <span class="function"><span class="params">envPath</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">//判断路径是否存在env的文件，存在就读取文件遍历设置env</span></span><br><span class="line">    <span class="keyword">if</span> (existsSync(envPath)) &#123;</span><br><span class="line">      <span class="keyword">const</span> parsed = parse(readFileSync(envPath, <span class="string">'utf-8'</span>));</span><br><span class="line">      <span class="built_in">Object</span>.keys(parsed).forEach(<span class="function"><span class="params">key</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (!process.env.hasOwnProperty(key)) &#123;</span><br><span class="line">          process.env[key] = parsed[key];</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line">  <span class="comment">//加载.env环境</span></span><br><span class="line">  loadEnv(baseEnvPath);</span><br><span class="line">  <span class="comment">//加载.env.local环境覆盖.env环境</span></span><br><span class="line">  loadEnv(localEnvPath);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="packages-umi-src-scripts-build-js"><a href="#packages-umi-src-scripts-build-js" class="headerlink" title="packages/umi/src/scripts/build.js"></a>packages/umi/src/scripts/build.js</h5><p>构建执行脚本，实际调用 umi-build-dev 模块</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> yParser <span class="keyword">from</span> <span class="string">'yargs-parser'</span>;</span><br><span class="line"><span class="keyword">import</span> buildDevOpts <span class="keyword">from</span> <span class="string">'../buildDevOpts'</span>;</span><br><span class="line"></span><br><span class="line">process.env.NODE_ENV = <span class="string">'production'</span>; <span class="comment">//设置环境为生产环境</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> args = yParser(process.argv.slice(<span class="number">2</span>));</span><br><span class="line"><span class="keyword">const</span> Service = <span class="built_in">require</span>(<span class="string">'umi-build-dev/lib/Service'</span>).default;</span><br><span class="line"><span class="keyword">new</span> Service(buildDevOpts(args)).run(<span class="string">'build'</span>, args);</span><br></pre></td></tr></table></figure>
<h5 id="packages-umi-src-scripts-dev-js"><a href="#packages-umi-src-scripts-dev-js" class="headerlink" title="packages/umi/src/scripts/dev.js"></a>packages/umi/src/scripts/dev.js</h5><p>开发执行脚本，实际调用 umi-build-dev 模块</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> fork <span class="keyword">from</span> <span class="string">'umi-build-dev/lib/fork'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> child = fork(<span class="built_in">require</span>.resolve(<span class="string">'./realDev.js'</span>));</span><br><span class="line">child.on(<span class="string">'message'</span>, data =&gt; &#123;</span><br><span class="line">  <span class="keyword">if</span> (process.send) &#123;</span><br><span class="line">    process.send(data);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br><span class="line">child.on(<span class="string">'exit'</span>, code =&gt; &#123;</span><br><span class="line">  <span class="keyword">if</span> (code === <span class="number">1</span>) &#123;</span><br><span class="line">    process.exit(code);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">process.on(<span class="string">'SIGINT'</span>, () =&gt; &#123;</span><br><span class="line">  child.kill(<span class="string">'SIGINT'</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<h5 id="packages-umi-src-scripts-inspect-js"><a href="#packages-umi-src-scripts-inspect-js" class="headerlink" title="packages/umi/src/scripts/inspect.js"></a>packages/umi/src/scripts/inspect.js</h5><p>检查内部 Webpack 配置脚本文件</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> yParser <span class="keyword">from</span> <span class="string">'yargs-parser'</span>;</span><br><span class="line"><span class="keyword">import</span> buildDevOpts <span class="keyword">from</span> <span class="string">'../buildDevOpts'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> args = yParser(process.argv.slice(<span class="number">2</span>));</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (args.mode === <span class="string">'production'</span>) &#123;</span><br><span class="line">  process.env.NODE_ENV = <span class="string">'production'</span>;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">  process.env.NODE_ENV = <span class="string">'development'</span>;</span><br><span class="line">&#125; <span class="comment">//如果命令指定了mode=production，则切换换生产环境否则为开发环境</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> Service = <span class="built_in">require</span>(<span class="string">'umi-build-dev/lib/Service'</span>).default;</span><br><span class="line"><span class="keyword">new</span> Service(buildDevOpts(args)).run(<span class="string">'inspect'</span>, args);</span><br></pre></td></tr></table></figure>
<h5 id="packages-umi-src-scripts-realDev-js"><a href="#packages-umi-src-scripts-realDev-js" class="headerlink" title="packages/umi/src/scripts/realDev.js"></a>packages/umi/src/scripts/realDev.js</h5><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> yParser <span class="keyword">from</span> <span class="string">'yargs-parser'</span>;</span><br><span class="line"><span class="keyword">import</span> buildDevOpts <span class="keyword">from</span> <span class="string">'../buildDevOpts'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> closed = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// kill(2) Ctrl-C</span></span><br><span class="line">process.once(<span class="string">'SIGINT'</span>, () =&gt; onSignal(<span class="string">'SIGINT'</span>));</span><br><span class="line"><span class="comment">// kill(3) Ctrl-\</span></span><br><span class="line">process.once(<span class="string">'SIGQUIT'</span>, () =&gt; onSignal(<span class="string">'SIGQUIT'</span>));</span><br><span class="line"><span class="comment">// kill(15) default</span></span><br><span class="line">process.once(<span class="string">'SIGTERM'</span>, () =&gt; onSignal(<span class="string">'SIGTERM'</span>));</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">onSignal</span>(<span class="params">signal</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (closed) <span class="keyword">return</span>;</span><br><span class="line">  closed = <span class="literal">true</span>;</span><br><span class="line">  process.exit(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">process.env.NODE_ENV = <span class="string">'development'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> args = yParser(process.argv.slice(<span class="number">2</span>));</span><br><span class="line"><span class="keyword">const</span> Service = <span class="built_in">require</span>(<span class="string">'umi-build-dev/lib/Service'</span>).default;</span><br><span class="line"><span class="keyword">new</span> Service(buildDevOpts(args)).run(<span class="string">'dev'</span>, args);</span><br></pre></td></tr></table></figure>
<h4 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h4><h5 id="packages-umi-src-test-js"><a href="#packages-umi-src-test-js" class="headerlink" title="packages/umi/src/test.js"></a>packages/umi/src/test.js</h5><p>测试脚本</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> yParser <span class="keyword">from</span> <span class="string">'yargs-parser'</span>;</span><br><span class="line"><span class="keyword">import</span> buildDevOpts <span class="keyword">from</span> <span class="string">'../buildDevOpts'</span>;</span><br><span class="line"></span><br><span class="line">process.env.NODE_ENV = <span class="string">'development'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> args = yParser(process.argv.slice(<span class="number">2</span>));</span><br><span class="line"><span class="keyword">const</span> Service = <span class="built_in">require</span>(<span class="string">'umi-build-dev/lib/Service'</span>).default;</span><br><span class="line"><span class="keyword">new</span> Service(buildDevOpts(args)).run(<span class="string">'test'</span>, args);</span><br></pre></td></tr></table></figure>
<h5 id="packages-umi-src-babel-js"><a href="#packages-umi-src-babel-js" class="headerlink" title="packages/umi/src/babel.js"></a>packages/umi/src/babel.js</h5><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="function"><span class="keyword">function</span>(<span class="params">context, opts = &#123;&#125;</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    presets: [</span><br><span class="line">      [</span><br><span class="line">        <span class="built_in">require</span>.resolve(<span class="string">'babel-preset-umi'</span>),</span><br><span class="line">        &#123;</span><br><span class="line">          ...opts,</span><br><span class="line">          preact: <span class="literal">true</span></span><br><span class="line">        &#125;</span><br><span class="line">      ]</span><br><span class="line">    ]</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="packages-umi-src-createHistory-js"><a href="#packages-umi-src-createHistory-js" class="headerlink" title="packages/umi/src/createHistory.js"></a>packages/umi/src/createHistory.js</h5><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> createHistory <span class="keyword">from</span> <span class="string">'history/createBrowserHistory'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; normalizePath &#125; <span class="keyword">from</span> <span class="string">'./utils'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="function"><span class="keyword">function</span>(<span class="params">opts</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> history = createHistory(opts);</span><br><span class="line">  <span class="keyword">if</span> (__UMI_HTML_SUFFIX) &#123;</span><br><span class="line">    <span class="keyword">const</span> oldPush = history.push;</span><br><span class="line">    <span class="keyword">const</span> oldReplace = history.replace;</span><br><span class="line">    history.push = <span class="function">(<span class="params">path, state</span>) =&gt;</span> &#123;</span><br><span class="line">      oldPush(normalizePath(path), state);</span><br><span class="line">    &#125;;</span><br><span class="line">    history.replace = <span class="function">(<span class="params">path, state</span>) =&gt;</span> &#123;</span><br><span class="line">      oldReplace(normalizePath(path), state);</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> history;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="packages-umi-src-prompt-js"><a href="#packages-umi-src-prompt-js" class="headerlink" title="packages/umi/src/prompt.js"></a>packages/umi/src/prompt.js</h5><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; Prompt &#125; <span class="keyword">from</span> <span class="string">'react-router-dom'</span>;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> Prompt;</span><br></pre></td></tr></table></figure>
<h5 id="packages-umi-src-renderRoutes-js"><a href="#packages-umi-src-renderRoutes-js" class="headerlink" title="packages/umi/src/renderRoutes.js"></a>packages/umi/src/renderRoutes.js</h5><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React <span class="keyword">from</span> <span class="string">'react'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; Switch, Route, Redirect &#125; <span class="keyword">from</span> <span class="string">'react-router-dom'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> RouteInstanceMap = &#123;</span><br><span class="line">  <span class="keyword">get</span>(key) &#123;</span><br><span class="line">    <span class="keyword">return</span> key._routeInternalComponent;</span><br><span class="line">  &#125;,</span><br><span class="line">  has(key) &#123;</span><br><span class="line">    <span class="keyword">return</span> key._routeInternalComponent !== <span class="literal">undefined</span>;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="keyword">set</span>(key, value) &#123;</span><br><span class="line">    key._routeInternalComponent = value;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Support pass props from layout to child routes</span></span><br><span class="line"><span class="keyword">const</span> RouteWithProps = <span class="function">(<span class="params">&#123; path, exact, strict, render, location, sensitive, ...rest &#125;</span>) =&gt;</span> (</span><br><span class="line">  &lt;Route path=&#123;path&#125; exact=&#123;exact&#125; strict=&#123;strict&#125; location=&#123;location&#125; sensitive=&#123;sensitive&#125; render=&#123;props =&gt; render(&#123; ...props, ...rest &#125;)&#125; /&gt;</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getCompatProps</span>(<span class="params">props</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> compatProps = &#123;&#125;;</span><br><span class="line">  <span class="keyword">if</span> (__UMI_BIGFISH_COMPAT) &#123;</span><br><span class="line">    <span class="keyword">if</span> (props.match &amp;&amp; props.match.params &amp;&amp; !props.params) &#123;</span><br><span class="line">      compatProps.params = props.match.params;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> compatProps;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">withRoutes</span>(<span class="params">route</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (RouteInstanceMap.has(route)) &#123;</span><br><span class="line">    <span class="keyword">return</span> RouteInstanceMap.get(route);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> &#123; Routes &#125; = route;</span><br><span class="line">  <span class="keyword">let</span> len = Routes.length - <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">let</span> Component = <span class="function"><span class="params">args</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; render, ...props &#125; = args;</span><br><span class="line">    <span class="keyword">return</span> render(props);</span><br><span class="line">  &#125;;</span><br><span class="line">  <span class="keyword">while</span> (len &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> AuthRoute = Routes[len];</span><br><span class="line">    <span class="keyword">const</span> OldComponent = Component;</span><br><span class="line">    Component = <span class="function"><span class="params">props</span> =&gt;</span> (</span><br><span class="line">      &lt;AuthRoute &#123;...props&#125;&gt;</span><br><span class="line">        &lt;OldComponent &#123;...props&#125; /&gt;</span><br><span class="line">      &lt;<span class="regexp">/AuthRoute&gt;</span></span><br><span class="line"><span class="regexp">    );</span></span><br><span class="line"><span class="regexp">    len -= 1;</span></span><br><span class="line"><span class="regexp">  &#125;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">  const ret = args =&gt; &#123;</span></span><br><span class="line"><span class="regexp">    const &#123; render, ...rest &#125; = args;</span></span><br><span class="line"><span class="regexp">    return (</span></span><br><span class="line"><span class="regexp">      &lt;RouteWithProps</span></span><br><span class="line"><span class="regexp">        &#123;...rest&#125;</span></span><br><span class="line"><span class="regexp">        render=&#123;props =&gt; &#123;</span></span><br><span class="line"><span class="regexp">          return &lt;Component &#123;...props&#125; route=&#123;route&#125; render=&#123;render&#125; /</span>&gt;;</span><br><span class="line">        &#125;&#125;</span><br><span class="line">      /&gt;</span><br><span class="line">    );</span><br><span class="line">  &#125;;</span><br><span class="line">  RouteInstanceMap.set(route, ret);</span><br><span class="line">  <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="function"><span class="keyword">function</span> <span class="title">renderRoutes</span>(<span class="params">routes, extraProps = &#123;&#125;, switchProps = &#123;&#125;</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> routes ? (</span><br><span class="line">    &lt;Switch &#123;...switchProps&#125;&gt;</span><br><span class="line">      &#123;routes.map(<span class="function">(<span class="params">route, i</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (route.redirect) &#123;</span><br><span class="line">          <span class="keyword">return</span> <span class="xml"><span class="tag">&lt;<span class="name">Redirect</span> <span class="attr">key</span>=<span class="string">&#123;route.key</span> || <span class="attr">i</span>&#125; <span class="attr">from</span>=<span class="string">&#123;route.path&#125;</span> <span class="attr">to</span>=<span class="string">&#123;route.redirect&#125;</span> <span class="attr">exact</span>=<span class="string">&#123;route.exact&#125;</span> <span class="attr">strict</span>=<span class="string">&#123;route.strict&#125;</span> /&gt;</span>;</span></span><br><span class="line"><span class="xml">        &#125;</span></span><br><span class="line"><span class="xml">        const RouteRoute = route.Routes ? withRoutes(route) : RouteWithProps;</span></span><br><span class="line"><span class="xml">        return (</span></span><br><span class="line">          &lt;RouteRoute</span><br><span class="line">            key=&#123;route.key || i&#125;</span><br><span class="line">            path=&#123;route.path&#125;</span><br><span class="line">            exact=&#123;route.exact&#125;</span><br><span class="line">            strict=&#123;route.strict&#125;</span><br><span class="line">            sensitive=&#123;route.sensitive&#125;</span><br><span class="line">            render=&#123;props =&gt; &#123;</span><br><span class="line">              const childRoutes = renderRoutes(</span><br><span class="line">                route.routes,</span><br><span class="line">                &#123;&#125;,</span><br><span class="line">                &#123;</span><br><span class="line">                  location: props.location</span><br><span class="line">                &#125;</span><br><span class="line">              );</span><br><span class="line">              if (route.component) &#123;</span><br><span class="line">                const compatProps = getCompatProps(&#123;</span><br><span class="line">                  ...props,</span><br><span class="line">                  ...extraProps</span><br><span class="line">                &#125;);</span><br><span class="line">                const newProps = window.g_plugins.apply('modifyRouteProps', &#123;</span><br><span class="line">                  initialValue: &#123;</span><br><span class="line">                    ...props,</span><br><span class="line">                    ...extraProps,</span><br><span class="line">                    ...compatProps</span><br><span class="line">                  &#125;,</span><br><span class="line">                  args: &#123; route &#125;</span><br><span class="line">                &#125;);</span><br><span class="line">                return (</span><br><span class="line">                  &lt;route.component &#123;...newProps&#125; route=&#123;route&#125;&gt;</span><br><span class="line">                    &#123;childRoutes&#125;</span><br><span class="line">                  &lt;/route.component&gt;</span><br><span class="line">                );</span><br><span class="line">              &#125; else &#123;</span><br><span class="line">                return childRoutes;</span><br><span class="line">              &#125;</span><br><span class="line">            &#125;&#125;</span><br><span class="line">          /&gt;</span><br><span class="line">        );</span><br><span class="line">      &#125;)&#125;</span><br><span class="line"><span class="xml">    <span class="tag">&lt;/<span class="name">Switch</span>&gt;</span></span></span><br><span class="line"><span class="xml">  ) : null;</span></span><br><span class="line"><span class="xml">&#125;</span></span><br></pre></td></tr></table></figure>
<h5 id="packages-umi-src-runtimePlugin-js"><a href="#packages-umi-src-runtimePlugin-js" class="headerlink" title="packages/umi/src/runtimePlugin.js"></a>packages/umi/src/runtimePlugin.js</h5><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> assert <span class="keyword">from</span> <span class="string">'assert'</span>;</span><br><span class="line"><span class="keyword">import</span> isPlainObject <span class="keyword">from</span> <span class="string">'lodash/isPlainObject'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> plugins = <span class="literal">null</span>;</span><br><span class="line"><span class="keyword">let</span> validKeys = [];</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">init</span>(<span class="params">opts = &#123;&#125;</span>) </span>&#123;</span><br><span class="line">  plugins = [];</span><br><span class="line">  validKeys = opts.validKeys || [];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">use</span>(<span class="params">plugin</span>) </span>&#123;</span><br><span class="line">  <span class="built_in">Object</span>.keys(plugin).forEach(<span class="function"><span class="params">key</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// <span class="doctag">TODO:</span> remove default</span></span><br><span class="line">    <span class="comment">// default 是为了兼容内部框架内置的一个 babel 插件问题</span></span><br><span class="line">    assert(validKeys.concat(<span class="string">'default'</span>).indexOf(key) &gt; <span class="number">-1</span>, <span class="string">`Invalid key <span class="subst">$&#123;key&#125;</span> from plugin`</span>);</span><br><span class="line">  &#125;);</span><br><span class="line">  plugins.push(plugin);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">getItem</span>(<span class="params">key</span>) </span>&#123;</span><br><span class="line">  assert(validKeys.indexOf(key) &gt; <span class="number">-1</span>, <span class="string">`Invalid key <span class="subst">$&#123;key&#125;</span>`</span>);</span><br><span class="line">  <span class="keyword">return</span> plugins.filter(<span class="function"><span class="params">plugin</span> =&gt;</span> key <span class="keyword">in</span> plugin).map(<span class="function"><span class="params">plugin</span> =&gt;</span> plugin[key]);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">_compose</span>(<span class="params">...funcs</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (funcs.length === <span class="number">1</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> funcs[<span class="number">0</span>];</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">const</span> last = funcs.pop();</span><br><span class="line">  <span class="keyword">return</span> funcs.reduce(<span class="function">(<span class="params">a, b</span>) =&gt;</span> <span class="function"><span class="params">()</span> =&gt;</span> b(a), last);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">compose</span>(<span class="params">item, &#123; initialValue &#125;</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> item === <span class="string">'string'</span>) item = getItem(item);</span><br><span class="line">  <span class="keyword">return</span> <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> _compose(...item, initialValue)();</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">apply</span>(<span class="params">item, &#123; initialValue, args &#125;</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> item === <span class="string">'string'</span>) item = getItem(item);</span><br><span class="line">  assert(<span class="built_in">Array</span>.isArray(item), <span class="string">`item must be Array`</span>);</span><br><span class="line">  <span class="keyword">return</span> item.reduce(<span class="function">(<span class="params">memo, fn</span>) =&gt;</span> &#123;</span><br><span class="line">    assert(<span class="keyword">typeof</span> fn === <span class="string">'function'</span>, <span class="string">`applied item must be function`</span>);</span><br><span class="line">    <span class="keyword">return</span> fn(memo, args);</span><br><span class="line">  &#125;, initialValue);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">applyForEach</span>(<span class="params">item, &#123; initialValue &#125;</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> item === <span class="string">'string'</span>) item = getItem(item);</span><br><span class="line">  assert(<span class="built_in">Array</span>.isArray(item), <span class="string">`item must be Array`</span>);</span><br><span class="line">  item.forEach(<span class="function"><span class="params">fn</span> =&gt;</span> &#123;</span><br><span class="line">    assert(<span class="keyword">typeof</span> fn === <span class="string">'function'</span>, <span class="string">`applied item must be function`</span>);</span><br><span class="line">    fn(initialValue);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// shadow merge</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">mergeConfig</span>(<span class="params">item</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> item === <span class="string">'string'</span>) item = getItem(item);</span><br><span class="line">  assert(<span class="built_in">Array</span>.isArray(item), <span class="string">`item must be Array`</span>);</span><br><span class="line">  <span class="keyword">return</span> item.reduce(<span class="function">(<span class="params">memo, config</span>) =&gt;</span> &#123;</span><br><span class="line">    assert(isPlainObject(config), <span class="string">`Config is not plain object`</span>);</span><br><span class="line">    <span class="keyword">return</span> &#123; ...memo, ...config &#125;;</span><br><span class="line">  &#125;, &#123;&#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="packages-umi-src-utils-js"><a href="#packages-umi-src-utils-js" class="headerlink" title="packages/umi/src/utils.js"></a>packages/umi/src/utils.js</h5><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">addHtmlAffix</span>(<span class="params">pathname</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (pathname.slice(<span class="number">-1</span>) === <span class="string">'/'</span> || pathname.slice(<span class="number">-5</span>) === <span class="string">'.html'</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> pathname;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">`<span class="subst">$&#123;pathname&#125;</span>.html`</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">normalizePath</span>(<span class="params">path</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> path === <span class="string">'string'</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> [pathname, search] = path.split(<span class="string">'?'</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="string">`<span class="subst">$&#123;addHtmlAffix(pathname)&#125;</span><span class="subst">$&#123;search ? <span class="string">'?'</span> : <span class="string">''</span>&#125;</span><span class="subst">$&#123;search || <span class="string">''</span>&#125;</span>`</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    ...path,</span><br><span class="line">    pathname: addHtmlAffix(path.pathname)</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="packages-umi-utils"><a href="#packages-umi-utils" class="headerlink" title="packages/umi-utils"></a>packages/umi-utils</h3><p>辅助 umi 的模块</p>
<h4 id="packages-umi-utils-src-winPath-js"><a href="#packages-umi-utils-src-winPath-js" class="headerlink" title="packages/umi-utils/src/winPath.js"></a>packages/umi-utils/src/winPath.js</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//将Windows反斜杠路径转换为斜杠路径：foo\\bar➔foo/ba</span></span><br><span class="line"><span class="keyword">import</span> slash <span class="keyword">from</span> <span class="string">'slash2'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="function"><span class="keyword">function</span>(<span class="params">path</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> slash(path);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="总结-4-30"><a href="#总结-4-30" class="headerlink" title="总结 4/30"></a>总结 4/30</h3><p>通过源码和视频学习了命令行运行包文件，虽然只是打印了<code>hello txp</code>（<a href="https://github.com/ShawDanon/txp/tree/master/packages/txp-first" target="_blank" rel="noopener">demo</a>）,阅读源码的同时对 node 印象更深刻了。疑惑的是 router 文件中的<code>window.g_history</code>不知道哪儿定义的，接下来需要看<code>umi-build-dev</code>模块了解构建运行的情况。</p>
<h3 id="参考二"><a href="#参考二" class="headerlink" title="参考二"></a>参考二</h3><p><a href="https://docs.npmjs.com/files/package.json" target="_blank" rel="noopener">配置 npm</a><br><a href="http://nodejs.cn/api/" target="_blank" rel="noopener">Node.js 中文网</a><br><a href="https://www.bilibili.com/video/av47877835" target="_blank" rel="noopener">基于 umi 封装自己的框架：sekiro</a></p>
<h2 id="学习-UMI（三）"><a href="#学习-UMI（三）" class="headerlink" title="学习 UMI（三）"></a>学习 UMI（三）</h2><p><a href="mailto:umi@2.6.17" target="_blank" rel="noopener">umi@2.6.17</a></p>
<h3 id="运行-umi-代码"><a href="#运行-umi-代码" class="headerlink" title="运行 umi 代码"></a>运行 umi 代码</h3><p>阅读代码，看文档，总感觉缺点什么，经过云嫌和小虎两位大佬帮助，开始了 umi 代码调试之旅。其实上个月就想边运行边看代码，只是连安装开发依赖都没解决，所以拖到了现在。<br>整个流程如下（也可以参考<a href="https://github.com/umijs/umi/blob/master/CONTRIBUTING.md" target="_blank" rel="noopener">贡献文档</a>）：<br>1、克隆 umi 项目，在 umi 更目录装开发依赖，贡献文档是推荐用 yarn 装，不过要是网络不好，没有科学上网条件，会卡在装<code>puppeteer</code>上面，具体原因不是包上面是要下载<code>Chromium</code>的时候网络超时失败的。所以解决方案是通过 cnpm 装。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cnpm i</span><br></pre></td></tr></table></figure>
<p>2、安装各个包依赖，因为用的 lerna 作为包管理工具,所以运行<code>lerna bootstrap</code>进行安装，当然也可可以参照贡献文档使用<code>yarn bootstrap</code>装，这只是 umi 包的一个 script 转换而已。<br>3、为了方便使用需要把 umi 链接到全局，链接到全局和全局装包效果是一样的。首先切换到 umi 包目录，<code>cd packages/umi</code>，然后可以使用<code>npm link</code>或者<code>yarn link</code>，建议使用 yarn，npm 链接有点慢。<br>4、链接完成后就可以运行 umi 的命令了，我们试一试，结果提示找不到 lib 目录。因此我们需要切回根目录，运行<code>yarn build</code>对所有包进行构建生成 lib 目录文件，贡献文档命令是<code>yarn build --watch</code>可以实现实时构建。如此运行 umi 命令就和直接通过<code>npm i umi -g</code>命令安装一样了。</p>
<h3 id="inspect"><a href="#inspect" class="headerlink" title="inspect"></a>inspect</h3><p>目前能够运行本地 umi 代码了，可以在 umi 中加入<code>console.log()</code>来打印需要的参数，但是这样也不是很方面来理解代码。参照<a href="https://umijs.org/zh/guide/faq.html#%E5%A6%82%E4%BD%95%E6%96%AD%E7%82%B9%E8%B0%83%E8%AF%95" target="_blank" rel="noopener">官方文档</a>可以通过 inspect 进行断点调试。<br>inspect 调试方法：<br>1、全局安装 node-inspect 包</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm i node-inspect -g</span><br></pre></td></tr></table></figure>
<p>2、在 umi 包目录运行<code>node --inspect-brk ./bin/umi dev</code>,<code>./bin/umi</code>是运行文件相对执行环境位置,<code>dev</code>是执行参数。成功运行能够看到打印信息如下。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Debugger listening on ws:<span class="comment">//127.0.0.1:9229/71f532b3-d619-4898-82ee-3145d817e5da</span></span><br><span class="line">For help, <span class="attr">see</span>: https:<span class="comment">//nodejs.org/en/docs/inspector</span></span><br></pre></td></tr></table></figure>
<p>3、进入调试器有两种方法，第一种是在谷歌浏览器输入<code>chrome://inspect/#devices</code>中打开，第二种是谷歌浏览器按 F12 唤醒开发者工具里打开，如下图。<br><figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="../../img/2019/5-27-1.png" alt="图一" title>
                </div>
                <div class="image-caption">图一</div>
            </figure><br>调试器如下图，基本操作和平时调试差不多。唯一遇到的坑就是 require 其他文件的时候进不去，试过在代码里加 debugger 也不行。最后发现左侧 Node 栏里面的文件是根据代码运行变化的，require 模块后 Node 栏里就会多出相应模块的代码，然后这个时候通过 Node 栏打开代码打断点即可调试。<br><figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="../../img/2019/5-27-2.png" alt="图二" title>
                </div>
                <div class="image-caption">图二</div>
            </figure></p>
<h3 id="umi-命令内部运行过程"><a href="#umi-命令内部运行过程" class="headerlink" title="umi 命令内部运行过程"></a>umi 命令内部运行过程</h3><p>目前主要看了 umi 包和 umi-build-dev 包，umi 主要提供运行时接口和编译时命令引导；umi-build-dev 包主要是编译时的工作，还包含内置插件（dev、build 等）。<br>例如运行<code>umi</code>这个命令不加任何参数：</p>
<ol>
<li>首先是进入 <code>packages/umi/bin/umi.js</code> 主文件，其功能是将命令分发到<code>packages/umi/src/cli.js</code>文件。</li>
<li>cli 文件对 umi 包进行检查，会提示版本更新。然后把命令分发到 script 文件执行命令，如果命令不存在直接执行命令。</li>
<li>执行命令文件<code>packages/umi-build-dev/src/Service</code>是一个类，构造函数会注册 Babel、解析用户配置、解析插件（解析插件会把内置插件和用户配置插件整合到一个数组中）。</li>
<li>然后命令执行运行类的 run 方法，如果 umi 命令没有参数则默认运行 help 命令。该方法会先初始化（加载环境.env、初始化插件、加载用户配置）。然后执行运行命令方法，该方法执行 umi 内部插件。</li>
</ol>
<h3 id="看过的一些源码及注释-packages-umi-build-dev"><a href="#看过的一些源码及注释-packages-umi-build-dev" class="headerlink" title="看过的一些源码及注释 packages/umi-build-dev"></a>看过的一些源码及注释 packages/umi-build-dev</h3><h4 id="packages-umi-build-dev-src-Service"><a href="#packages-umi-build-dev-src-Service" class="headerlink" title="packages/umi-build-dev/src/Service"></a>packages/umi-build-dev/src/Service</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> chalk <span class="keyword">from</span> <span class="string">'chalk'</span>; <span class="comment">//终端字符串样式做得很好(终端字符串颜色处理插件)</span></span><br><span class="line"><span class="comment">//path.dirname() 方法返回 path 的目录名，类似于 Unix 的 dirname 命令。</span></span><br><span class="line"><span class="comment">//path.join() 方法返回字符串拼接路径。</span></span><br><span class="line"><span class="keyword">import</span> &#123; join, dirname &#125; <span class="keyword">from</span> <span class="string">'path'</span>;</span><br><span class="line"><span class="comment">//existsSync 同步通过检查文件系统来测试给定的路径是否存在。</span></span><br><span class="line"><span class="comment">//readFileSync 同步读取文件</span></span><br><span class="line"><span class="comment">//writeFileSync 同步写入文件</span></span><br><span class="line"><span class="keyword">import</span> &#123; existsSync, readFileSync, writeFileSync &#125; <span class="keyword">from</span> <span class="string">'fs'</span>;</span><br><span class="line"><span class="keyword">import</span> assert <span class="keyword">from</span> <span class="string">'assert'</span>; <span class="comment">//此模块用于为您的应用程序编写单元测试</span></span><br><span class="line"><span class="keyword">import</span> mkdirp <span class="keyword">from</span> <span class="string">'mkdirp'</span>; <span class="comment">//mkdir -p作用，确保目录名称存在，如果目录不存在的就新创建一个。</span></span><br><span class="line"><span class="comment">//assign 浅拷贝</span></span><br><span class="line"><span class="comment">//cloneDeep 深拷贝</span></span><br><span class="line"><span class="keyword">import</span> &#123; assign, cloneDeep &#125; <span class="keyword">from</span> <span class="string">'lodash'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; parse &#125; <span class="keyword">from</span> <span class="string">'dotenv'</span>; <span class="comment">//Dotenv是一个零依赖模块，可以将.env文件中的环境变量加载到process.env</span></span><br><span class="line"><span class="keyword">import</span> signale <span class="keyword">from</span> <span class="string">'signale'</span>; <span class="comment">//可记录和可配置到核心，signale可用于记录目的，状态报告，以及处理其他节点模块和应用程序的输出呈现过程。终端中命令执行成功失败异常等的状态</span></span><br><span class="line"><span class="comment">//deprecate 用于终端上提示方法被弃用,传入(方法名，...想要提示的其他信息),调用方法终端输出提示信息。</span></span><br><span class="line"><span class="keyword">import</span> &#123; deprecate &#125; <span class="keyword">from</span> <span class="string">'umi-utils'</span>;</span><br><span class="line"><span class="keyword">import</span> getPaths <span class="keyword">from</span> <span class="string">'./getPaths'</span>;</span><br><span class="line"><span class="keyword">import</span> getPlugins <span class="keyword">from</span> <span class="string">'./getPlugins'</span>;</span><br><span class="line"><span class="keyword">import</span> PluginAPI <span class="keyword">from</span> <span class="string">'./PluginAPI'</span>;</span><br><span class="line"><span class="keyword">import</span> UserConfig <span class="keyword">from</span> <span class="string">'./UserConfig'</span>;</span><br><span class="line"><span class="keyword">import</span> registerBabel <span class="keyword">from</span> <span class="string">'./registerBabel'</span>;</span><br><span class="line"><span class="keyword">import</span> getCodeFrame <span class="keyword">from</span> <span class="string">'./utils/getCodeFrame'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> debug = <span class="built_in">require</span>(<span class="string">'debug'</span>)(<span class="string">'umi-build-dev:Service'</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//服务类</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="class"><span class="keyword">class</span> <span class="title">Service</span> </span>&#123;</span><br><span class="line">  <span class="comment">//构造函数传入目录</span></span><br><span class="line">  <span class="keyword">constructor</span>(&#123; cwd &#125;) &#123;</span><br><span class="line">    <span class="comment">//cwd为app根目录</span></span><br><span class="line">    <span class="comment">//process.cwd() 方法返回 Node.js 进程的当前工作目录。</span></span><br><span class="line">    <span class="keyword">this</span>.cwd = cwd || process.cwd(); <span class="comment">//如果不传入cwd，cwd为Node.js 进程的当前工作目录.</span></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">this</span>.pkg = <span class="built_in">require</span>(join(<span class="keyword">this</span>.cwd, <span class="string">'package.json'</span>)); <span class="comment">// 引入项目package.json，pkg为json对象</span></span><br><span class="line">    &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">      <span class="keyword">this</span>.pkg = &#123;&#125;; <span class="comment">//不存在package.json则pkg为空对象</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    registerBabel(&#123;</span><br><span class="line">      cwd: <span class="keyword">this</span>.cwd</span><br><span class="line">    &#125;); <span class="comment">//注册Babel</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">this</span>.commands = &#123;&#125;;</span><br><span class="line">    <span class="keyword">this</span>.pluginHooks = &#123;&#125;;</span><br><span class="line">    <span class="keyword">this</span>.pluginMethods = &#123;&#125;;</span><br><span class="line">    <span class="keyword">this</span>.generators = &#123;&#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 解析用户配置</span></span><br><span class="line">    <span class="keyword">this</span>.config = UserConfig.getConfig(&#123;</span><br><span class="line">      cwd: <span class="keyword">this</span>.cwd,</span><br><span class="line">      service: <span class="keyword">this</span></span><br><span class="line">    &#125;);</span><br><span class="line">    debug(<span class="string">`user config: <span class="subst">$&#123;<span class="built_in">JSON</span>.stringify(<span class="keyword">this</span>.config)&#125;</span> `</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 解析插件，内置插件和用户插件解析</span></span><br><span class="line">    <span class="keyword">this</span>.plugins = <span class="keyword">this</span>.resolvePlugins();</span><br><span class="line">    <span class="keyword">this</span>.extraPlugins = [];</span><br><span class="line">    debug(<span class="string">`plugins: <span class="subst">$&#123;<span class="keyword">this</span>.plugins.map(p =&gt; p.id).join(<span class="string">' | '</span>)&#125;</span> `</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 相对路径</span></span><br><span class="line">    <span class="keyword">this</span>.paths = getPaths(<span class="keyword">this</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  resolvePlugins() &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      assert(<span class="built_in">Array</span>.isArray(<span class="keyword">this</span>.config.plugins || []), <span class="string">`Configure item <span class="subst">$&#123;chalk.underline.cyan(<span class="string">'plugins'</span>)&#125;</span> should be Array, but got <span class="subst">$&#123;chalk.red(<span class="keyword">typeof</span> <span class="keyword">this</span>.config.plugins)&#125;</span> `</span>);</span><br><span class="line">      <span class="keyword">return</span> getPlugins(&#123;</span><br><span class="line">        cwd: <span class="keyword">this</span>.cwd,</span><br><span class="line">        plugins: <span class="keyword">this</span>.config.plugins || []</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">      <span class="keyword">if</span> (process.env.UMI_TEST) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(e);</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        signale.error(e);</span><br><span class="line">        process.exit(<span class="number">1</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="comment">//解析插件</span></span><br><span class="line"></span><br><span class="line">  initPlugin(plugin) &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; id, apply, opts &#125; = plugin;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      assert(</span><br><span class="line">        <span class="keyword">typeof</span> apply === <span class="string">'function'</span>,</span><br><span class="line">        <span class="string">`</span></span><br><span class="line"><span class="string">plugin must export a function, e.g.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">export default function (api) &#123;</span></span><br><span class="line"><span class="string">  // Implement functions via api</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">`</span>.trim()</span><br><span class="line">      );</span><br><span class="line">      <span class="keyword">const</span> api = <span class="keyword">new</span> <span class="built_in">Proxy</span>(<span class="keyword">new</span> PluginAPI(id, <span class="keyword">this</span>), &#123;</span><br><span class="line">        <span class="keyword">get</span>: (target, prop) =&gt; &#123;</span><br><span class="line">          <span class="keyword">if</span> (<span class="keyword">this</span>.pluginMethods[prop]) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">this</span>.pluginMethods[prop];</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">if</span> (</span><br><span class="line">            [</span><br><span class="line">              <span class="comment">// methods</span></span><br><span class="line">              <span class="string">'changePluginOption'</span>,</span><br><span class="line">              <span class="string">'applyPlugins'</span>,</span><br><span class="line">              <span class="string">'_applyPluginsAsync'</span>,</span><br><span class="line">              <span class="string">'writeTmpFile'</span>,</span><br><span class="line">              <span class="comment">// properties</span></span><br><span class="line">              <span class="string">'cwd'</span>,</span><br><span class="line">              <span class="string">'config'</span>,</span><br><span class="line">              <span class="string">'webpackConfig'</span>,</span><br><span class="line">              <span class="string">'pkg'</span>,</span><br><span class="line">              <span class="string">'paths'</span>,</span><br><span class="line">              <span class="string">'routes'</span>,</span><br><span class="line">              <span class="comment">// dev methods</span></span><br><span class="line">              <span class="string">'restart'</span>,</span><br><span class="line">              <span class="string">'printError'</span>,</span><br><span class="line">              <span class="string">'printWarn'</span>,</span><br><span class="line">              <span class="string">'refreshBrowser'</span>,</span><br><span class="line">              <span class="string">'rebuildTmpFiles'</span>,</span><br><span class="line">              <span class="string">'rebuildHTML'</span></span><br><span class="line">            ].includes(prop)</span><br><span class="line">          ) &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">typeof</span> <span class="keyword">this</span>[prop] === <span class="string">'function'</span>) &#123;</span><br><span class="line">              <span class="keyword">return</span> <span class="keyword">this</span>[prop].bind(<span class="keyword">this</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">              <span class="keyword">return</span> <span class="keyword">this</span>[prop];</span><br><span class="line">            &#125;</span><br><span class="line">          &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> target[prop];</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;);</span><br><span class="line">      api.onOptionChange = <span class="function"><span class="params">fn</span> =&gt;</span> &#123;</span><br><span class="line">        assert(<span class="keyword">typeof</span> fn === <span class="string">'function'</span>, <span class="string">`The first argument for api.onOptionChange should be function in <span class="subst">$&#123;id&#125;</span>.`</span>);</span><br><span class="line">        plugin.onOptionChange = fn;</span><br><span class="line">      &#125;;</span><br><span class="line">      apply(api, opts);</span><br><span class="line">      plugin._api = api;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">      <span class="keyword">if</span> (process.env.UMI_TEST) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(e);</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        signale.error(</span><br><span class="line">          <span class="string">`</span></span><br><span class="line"><span class="string">Plugin <span class="subst">$&#123;chalk.cyan.underline(id)&#125;</span> initialize failed</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"><span class="subst">$&#123;getCodeFrame(e, &#123; cwd: <span class="keyword">this</span>.cwd &#125;</span>)&#125;</span></span><br><span class="line"><span class="string">`</span>.trim()</span><br><span class="line">        );</span><br><span class="line">        debug(e);</span><br><span class="line">        process.exit(<span class="number">1</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="comment">//初始化插件</span></span><br><span class="line"></span><br><span class="line">  initPlugins() &#123;</span><br><span class="line">    <span class="keyword">this</span>.plugins.forEach(<span class="function"><span class="params">plugin</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">this</span>.initPlugin(plugin);</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> count = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span> (<span class="keyword">this</span>.extraPlugins.length) &#123;</span><br><span class="line">      <span class="keyword">const</span> extraPlugins = cloneDeep(<span class="keyword">this</span>.extraPlugins);</span><br><span class="line">      <span class="keyword">this</span>.extraPlugins = [];</span><br><span class="line">      extraPlugins.forEach(<span class="function"><span class="params">plugin</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">this</span>.initPlugin(plugin);</span><br><span class="line">        <span class="keyword">this</span>.plugins.push(plugin);</span><br><span class="line">      &#125;);</span><br><span class="line">      count += <span class="number">1</span>;</span><br><span class="line">      assert(count &lt;= <span class="number">10</span>, <span class="string">`插件注册死循环？`</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Throw error for methods that can't be called after plugins is initialized</span></span><br><span class="line">    <span class="keyword">this</span>.plugins.forEach(<span class="function"><span class="params">plugin</span> =&gt;</span> &#123;</span><br><span class="line">      [<span class="string">'onOptionChange'</span>, <span class="string">'register'</span>, <span class="string">'registerMethod'</span>, <span class="string">'registerPlugin'</span>].forEach(<span class="function"><span class="params">method</span> =&gt;</span> &#123;</span><br><span class="line">        plugin._api[method] = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">          <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">`api.<span class="subst">$&#123;method&#125;</span> () should not be called after plugin is initialized.`</span>);</span><br><span class="line">        &#125;;</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125; <span class="comment">//初始化插件集</span></span><br><span class="line"></span><br><span class="line">  changePluginOption(id, newOpts) &#123;</span><br><span class="line">    assert(id, <span class="string">`id must supplied`</span>);</span><br><span class="line">    <span class="keyword">const</span> plugin = <span class="keyword">this</span>.plugins.filter(<span class="function"><span class="params">p</span> =&gt;</span> p.id === id)[<span class="number">0</span>];</span><br><span class="line">    assert(plugin, <span class="string">`plugin <span class="subst">$&#123;id&#125;</span> not found`</span>);</span><br><span class="line">    plugin.opts = newOpts;</span><br><span class="line">    <span class="keyword">if</span> (plugin.onOptionChange) &#123;</span><br><span class="line">      plugin.onOptionChange(newOpts);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">this</span>.restart(<span class="string">`plugin <span class="subst">$&#123;id&#125;</span> 's option changed`</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  applyPlugins(key, opts = &#123;&#125;) &#123;</span><br><span class="line">    debug(<span class="string">`apply plugins <span class="subst">$&#123;key&#125;</span>`</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="function">(<span class="params"><span class="keyword">this</span>.pluginHooks[key] || []</span>).<span class="params">reduce</span>(<span class="params">(memo, &#123; fn &#125;</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> fn(&#123;</span><br><span class="line">          memo,</span><br><span class="line">          args: opts.args</span><br><span class="line">        &#125;);</span><br><span class="line">      &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">        <span class="built_in">console</span>.error(chalk.red(<span class="string">`Plugin apply failed: <span class="subst">$&#123;e.message&#125;</span>`</span>));</span><br><span class="line">        <span class="keyword">throw</span> e;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;, opts.initialValue);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">async</span> _applyPluginsAsync(key, opts = &#123;&#125;) &#123;</span><br><span class="line">    debug(<span class="string">`apply plugins async <span class="subst">$&#123;key&#125;</span>`</span>);</span><br><span class="line">    <span class="keyword">const</span> hooks = <span class="keyword">this</span>.pluginHooks[key] || [];</span><br><span class="line">    <span class="keyword">let</span> memo = opts.initialValue;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">const</span> hook <span class="keyword">of</span> hooks) &#123;</span><br><span class="line">      <span class="keyword">const</span> &#123; fn &#125; = hook;</span><br><span class="line">      memo = <span class="keyword">await</span> fn(&#123;</span><br><span class="line">        memo,</span><br><span class="line">        args: opts.args</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> memo;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  loadEnv() &#123;</span><br><span class="line">    <span class="keyword">const</span> basePath = join(<span class="keyword">this</span>.cwd, <span class="string">'.env'</span>); <span class="comment">//基础配置路径</span></span><br><span class="line">    <span class="keyword">const</span> localPath = <span class="string">`<span class="subst">$&#123;basePath&#125;</span>.local`</span>; <span class="comment">//本地配置路径</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> load = <span class="function"><span class="params">path</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (existsSync(path)) &#123;</span><br><span class="line">        debug(<span class="string">`load env from <span class="subst">$&#123;path&#125;</span>`</span>);</span><br><span class="line">        <span class="keyword">const</span> parsed = parse(readFileSync(path, <span class="string">'utf-8'</span>));</span><br><span class="line">        <span class="built_in">Object</span>.keys(parsed).forEach(<span class="function"><span class="params">key</span> =&gt;</span> &#123;</span><br><span class="line">          <span class="keyword">if</span> (!process.env.hasOwnProperty(key)) &#123;</span><br><span class="line">            process.env[key] = parsed[key];</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    load(basePath); <span class="comment">//加载基础配置</span></span><br><span class="line">    load(localPath); <span class="comment">//加载本地配置，覆盖基础配置</span></span><br><span class="line">  &#125; <span class="comment">//加载环境</span></span><br><span class="line"></span><br><span class="line">  writeTmpFile(file, content) &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; paths &#125; = <span class="keyword">this</span>;</span><br><span class="line">    <span class="keyword">const</span> path = join(paths.absTmpDirPath, file);</span><br><span class="line">    mkdirp.sync(dirname(path));</span><br><span class="line">    writeFileSync(path, content, <span class="string">'utf-8'</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  init() &#123;</span><br><span class="line">    <span class="comment">// 加载环境</span></span><br><span class="line">    <span class="keyword">this</span>.loadEnv();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 初始化插件</span></span><br><span class="line">    <span class="keyword">this</span>.initPlugins();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 加载用户配置</span></span><br><span class="line">    <span class="keyword">const</span> userConfig = <span class="keyword">new</span> UserConfig(<span class="keyword">this</span>);</span><br><span class="line">    <span class="keyword">const</span> config = userConfig.getConfig(&#123; <span class="attr">force</span>: <span class="literal">true</span> &#125;);</span><br><span class="line">    mergeConfig(<span class="keyword">this</span>.config, config);</span><br><span class="line">    <span class="keyword">this</span>.userConfig = userConfig;</span><br><span class="line">    <span class="keyword">if</span> (config.browserslist) &#123;</span><br><span class="line">      deprecate(<span class="string">'config.browserslist'</span>, <span class="string">'use config.targets instead'</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    debug(<span class="string">'got user config'</span>);</span><br><span class="line">    debug(<span class="keyword">this</span>.config);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// assign user's outputPath config to paths object</span></span><br><span class="line">    <span class="keyword">if</span> (config.outputPath) &#123;</span><br><span class="line">      <span class="keyword">const</span> &#123; paths &#125; = <span class="keyword">this</span>;</span><br><span class="line">      paths.outputPath = config.outputPath;</span><br><span class="line">      paths.absOutputPath = join(paths.cwd, config.outputPath);</span><br><span class="line">    &#125;</span><br><span class="line">    debug(<span class="string">'got paths'</span>);</span><br><span class="line">    debug(<span class="keyword">this</span>.paths);</span><br><span class="line">  &#125; <span class="comment">//初始化</span></span><br><span class="line"></span><br><span class="line">  registerCommand(name, opts, fn) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> opts === <span class="string">'function'</span>) &#123;</span><br><span class="line">      fn = opts;</span><br><span class="line">      opts = <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    opts = opts || &#123;&#125;;</span><br><span class="line">    assert(!(name <span class="keyword">in</span> <span class="keyword">this</span>.commands), <span class="string">`Command <span class="subst">$&#123;name&#125;</span> exists, please select another one.`</span>);</span><br><span class="line">    <span class="keyword">this</span>.commands[name] = &#123; fn, opts &#125;;</span><br><span class="line">  &#125; <span class="comment">//注册命令，在PluginAPI中调用</span></span><br><span class="line"></span><br><span class="line">  run(name = <span class="string">'help'</span>, args) &#123;</span><br><span class="line">    <span class="keyword">this</span>.init(); <span class="comment">//初始化</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.runCommand(name, args); <span class="comment">//运行help命令</span></span><br><span class="line">  &#125; <span class="comment">//启动servers</span></span><br><span class="line"></span><br><span class="line">  runCommand(rawName, rawArgs) &#123;</span><br><span class="line">    debug(<span class="string">`raw command name: <span class="subst">$&#123;rawName&#125;</span>, args: <span class="subst">$&#123;<span class="built_in">JSON</span>.stringify(rawArgs)&#125;</span>`</span>);</span><br><span class="line">    <span class="keyword">const</span> &#123; name, args &#125; = <span class="keyword">this</span>.applyPlugins(<span class="string">'_modifyCommand'</span>, &#123;</span><br><span class="line">      initialValue: &#123;</span><br><span class="line">        name: rawName,</span><br><span class="line">        args: rawArgs</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    debug(<span class="string">`run <span class="subst">$&#123;name&#125;</span> with args <span class="subst">$&#123;<span class="built_in">JSON</span>.stringify(args)&#125;</span>`</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> command = <span class="keyword">this</span>.commands[name];</span><br><span class="line">    <span class="keyword">if</span> (!command) &#123;</span><br><span class="line">      signale.error(<span class="string">`Command <span class="subst">$&#123;chalk.underline.cyan(name)&#125;</span> does not exists`</span>);</span><br><span class="line">      process.exit(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> &#123; fn, opts &#125; = command;</span><br><span class="line">    <span class="keyword">if</span> (opts.webpack) &#123;</span><br><span class="line">      <span class="comment">// webpack config</span></span><br><span class="line">      <span class="keyword">this</span>.webpackConfig = <span class="built_in">require</span>(<span class="string">'./getWebpackConfig'</span>).default(<span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> fn(args);</span><br><span class="line">  &#125; <span class="comment">//运行命令</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">mergeConfig</span>(<span class="params">oldConfig, newConfig</span>) </span>&#123;</span><br><span class="line">  <span class="built_in">Object</span>.keys(oldConfig).forEach(<span class="function"><span class="params">key</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (!(key <span class="keyword">in</span> newConfig)) &#123;</span><br><span class="line">      <span class="keyword">delete</span> oldConfig[key];</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;);</span><br><span class="line">  assign(oldConfig, newConfig);</span><br><span class="line">  <span class="keyword">return</span> oldConfig;</span><br><span class="line">&#125; <span class="comment">//合并配置项</span></span><br></pre></td></tr></table></figure>
<h4 id="packages-umi-build-dev-src-registerBabel"><a href="#packages-umi-build-dev-src-registerBabel" class="headerlink" title="packages/umi-build-dev/src/registerBabel"></a>packages/umi-build-dev/src/registerBabel</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; join, isAbsolute &#125; <span class="keyword">from</span> <span class="string">'path'</span>; <span class="comment">//引入拼接路径模块和判断是否为绝对路劲模块</span></span><br><span class="line"><span class="keyword">import</span> &#123; existsSync &#125; <span class="keyword">from</span> <span class="string">'fs'</span>; <span class="comment">//同步检查路肩是否存在模块</span></span><br><span class="line"><span class="keyword">import</span> registerBabel <span class="keyword">from</span> <span class="string">'af-webpack/registerBabel'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; winPath &#125; <span class="keyword">from</span> <span class="string">'umi-utils'</span>;</span><br><span class="line"><span class="comment">//获取umi配置文件路径的数组</span></span><br><span class="line"><span class="keyword">import</span> &#123; getConfigPaths &#125; <span class="keyword">from</span> <span class="string">'umi-core/lib/getUserConfig'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> files = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">initFiles</span>(<span class="params">cwd</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (files) <span class="keyword">return</span>;</span><br><span class="line">  files = getConfigPaths(cwd); <span class="comment">//传入node运行时路径</span></span><br><span class="line">&#125; <span class="comment">//初始化文件，若文件存在则忽略</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">addBabelRegisterFiles</span>(<span class="params">extraFiles, &#123; cwd &#125;</span>) </span>&#123;</span><br><span class="line">  initFiles(cwd);</span><br><span class="line">  files.push(...extraFiles);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="function"><span class="keyword">function</span>(<span class="params">&#123; cwd &#125;</span>) </span>&#123;</span><br><span class="line">  initFiles(cwd);</span><br><span class="line">  <span class="keyword">const</span> only = files.map(<span class="function"><span class="params">f</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> fullPath = isAbsolute(f) ? f : join(cwd, f);</span><br><span class="line">    <span class="keyword">return</span> winPath(fullPath);</span><br><span class="line">  &#125;); <span class="comment">//转化路径</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> absSrcPath = join(cwd, <span class="string">'src'</span>); <span class="comment">//获取src目录路径</span></span><br><span class="line">  <span class="keyword">if</span> (!existsSync(absSrcPath)) &#123;</span><br><span class="line">    absSrcPath = cwd;</span><br><span class="line">  &#125; <span class="comment">//如果不存在src目录则把根目录作为src目录</span></span><br><span class="line"></span><br><span class="line">  registerBabel(&#123;</span><br><span class="line">    <span class="comment">// only suport glob</span></span><br><span class="line">    <span class="comment">// ref: https://babeljs.io/docs/en/next/babel-core.html#configitem-type</span></span><br><span class="line">    only,</span><br><span class="line">    babelPreset: [</span><br><span class="line">      <span class="built_in">require</span>.resolve(<span class="string">'babel-preset-umi'</span>),</span><br><span class="line">      &#123;</span><br><span class="line">        env: &#123; <span class="attr">targets</span>: &#123; <span class="attr">node</span>: <span class="number">8</span> &#125; &#125;,</span><br><span class="line">        transformRuntime: <span class="literal">false</span></span><br><span class="line">      &#125;</span><br><span class="line">    ],</span><br><span class="line">    babelPlugins: [</span><br><span class="line">      [</span><br><span class="line">        <span class="built_in">require</span>.resolve(<span class="string">'babel-plugin-module-resolver'</span>),</span><br><span class="line">        &#123;</span><br><span class="line">          alias: &#123;</span><br><span class="line">            <span class="string">'@'</span>: absSrcPath</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      ]</span><br><span class="line">    ]</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="packages-umi-build-dev-src-UserConfig"><a href="#packages-umi-build-dev-src-UserConfig" class="headerlink" title="packages/umi-build-dev/src/UserConfig"></a>packages/umi-build-dev/src/UserConfig</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; join &#125; <span class="keyword">from</span> <span class="string">'path'</span>;</span><br><span class="line"><span class="keyword">import</span> requireindex <span class="keyword">from</span> <span class="string">'requireindex'</span>;</span><br><span class="line"><span class="keyword">import</span> chalk <span class="keyword">from</span> <span class="string">'chalk'</span>;</span><br><span class="line"><span class="keyword">import</span> didyoumean <span class="keyword">from</span> <span class="string">'didyoumean'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; cloneDeep &#125; <span class="keyword">from</span> <span class="string">'lodash'</span>;</span><br><span class="line"><span class="keyword">import</span> signale <span class="keyword">from</span> <span class="string">'signale'</span>;</span><br><span class="line"><span class="keyword">import</span> getUserConfig, &#123; getConfigPaths, getConfigFile, getConfigByConfigFile, cleanConfigRequireCache &#125; <span class="keyword">from</span> <span class="string">'umi-core/lib/getUserConfig'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; watch, unwatch &#125; <span class="keyword">from</span> <span class="string">'./getConfig/watch'</span>;</span><br><span class="line"><span class="keyword">import</span> isEqual <span class="keyword">from</span> <span class="string">'./isEqual'</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserConfig</span> </span>&#123;</span><br><span class="line">  <span class="keyword">static</span> getConfig(opts = &#123;&#125;) &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; cwd, service &#125; = opts;</span><br><span class="line">    <span class="keyword">return</span> getUserConfig(&#123;</span><br><span class="line">      cwd,</span><br><span class="line">      defaultConfig: service.applyPlugins(<span class="string">'modifyDefaultConfig'</span>, &#123;</span><br><span class="line">        initialValue: &#123;&#125;</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">constructor</span>(service) &#123;</span><br><span class="line">    <span class="keyword">this</span>.service = service;</span><br><span class="line">    <span class="keyword">this</span>.configFailed = <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">this</span>.config = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">this</span>.file = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">this</span>.relativeFile = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">this</span>.watch = watch;</span><br><span class="line">    <span class="keyword">this</span>.unwatch = unwatch;</span><br><span class="line">    <span class="keyword">this</span>.initConfigPlugins();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  initConfigPlugins() &#123;</span><br><span class="line">    <span class="keyword">const</span> map = requireindex(join(__dirname, <span class="string">'getConfig/configPlugins'</span>));</span><br><span class="line">    <span class="keyword">let</span> plugins = <span class="built_in">Object</span>.keys(map).map(<span class="function"><span class="params">key</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> map[key].default;</span><br><span class="line">    &#125;);</span><br><span class="line">    plugins = <span class="keyword">this</span>.service.applyPlugins(<span class="string">'_registerConfig'</span>, &#123;</span><br><span class="line">      initialValue: plugins</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="keyword">this</span>.plugins = plugins.map(<span class="function"><span class="params">p</span> =&gt;</span> p(<span class="keyword">this</span>));</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  printError(messages) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.service.printError) <span class="keyword">this</span>.service.printError(messages);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  getConfig(opts = &#123;&#125;) &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; paths, cwd &#125; = <span class="keyword">this</span>.service;</span><br><span class="line">    <span class="keyword">const</span> &#123; force, setConfig &#125; = opts;</span><br><span class="line">    <span class="keyword">const</span> defaultConfig = <span class="keyword">this</span>.service.applyPlugins(<span class="string">'modifyDefaultConfig'</span>, &#123;</span><br><span class="line">      initialValue: &#123;&#125;</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> file = getConfigFile(cwd);</span><br><span class="line">    <span class="keyword">this</span>.file = file;</span><br><span class="line">    <span class="keyword">if</span> (!file) &#123;</span><br><span class="line">      <span class="keyword">return</span> defaultConfig;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 强制读取，不走 require 缓存</span></span><br><span class="line">    <span class="keyword">if</span> (force) &#123;</span><br><span class="line">      cleanConfigRequireCache(cwd);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> config = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">const</span> relativeFile = file.replace(<span class="string">`<span class="subst">$&#123;paths.cwd&#125;</span>/`</span>, <span class="string">''</span>);</span><br><span class="line">    <span class="keyword">this</span>.relativeFile = relativeFile;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> onError = <span class="function">(<span class="params">e, file</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> msg = <span class="string">`配置文件 "<span class="subst">$&#123;file.replace(<span class="string">`<span class="subst">$&#123;paths.cwd&#125;</span>/`</span>, <span class="string">''</span>)&#125;</span>" 解析出错，请检查语法。</span></span><br><span class="line"><span class="string">\r\n<span class="subst">$&#123;e.toString()&#125;</span>`</span>;</span><br><span class="line">      <span class="keyword">this</span>.printError(msg);</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(msg);</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    config = getConfigByConfigFile(file, &#123;</span><br><span class="line">      defaultConfig,</span><br><span class="line">      onError</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    config = <span class="keyword">this</span>.service.applyPlugins(<span class="string">'_modifyConfig'</span>, &#123;</span><br><span class="line">      initialValue: config</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Validate</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">const</span> plugin <span class="keyword">of</span> <span class="keyword">this</span>.plugins) &#123;</span><br><span class="line">      <span class="keyword">const</span> &#123; name, validate &#125; = plugin;</span><br><span class="line">      <span class="keyword">if</span> (config[name] &amp;&amp; validate) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">          plugin.validate.call(&#123; cwd &#125;, config[name]);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">          <span class="comment">// 校验出错后要把值设到缓存的 config 里，确保 watch 判断时才能拿到正确的值</span></span><br><span class="line">          <span class="keyword">if</span> (setConfig) &#123;</span><br><span class="line">            setConfig(config);</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">this</span>.printError(e.message);</span><br><span class="line">          <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">`配置 <span class="subst">$&#123;name&#125;</span> 校验失败, <span class="subst">$&#123;e.message&#125;</span>`</span>);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 找下不匹配的 name</span></span><br><span class="line">    <span class="keyword">const</span> pluginNames = <span class="keyword">this</span>.plugins.map(<span class="function"><span class="params">p</span> =&gt;</span> p.name);</span><br><span class="line">    <span class="built_in">Object</span>.keys(config).forEach(<span class="function"><span class="params">key</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (!pluginNames.includes(key)) &#123;</span><br><span class="line">        <span class="keyword">if</span> (opts.setConfig) &#123;</span><br><span class="line">          opts.setConfig(config);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">const</span> affixmsg = <span class="string">`选择 "<span class="subst">$&#123;pluginNames.join(<span class="string">', '</span>)&#125;</span>" 中的一项`</span>;</span><br><span class="line">        <span class="keyword">const</span> guess = didyoumean(key, pluginNames);</span><br><span class="line">        <span class="keyword">const</span> midMsg = guess ? <span class="string">`你是不是想配置 "<span class="subst">$&#123;guess&#125;</span>" ？ 或者`</span> : <span class="string">'请'</span>;</span><br><span class="line">        <span class="keyword">const</span> msg = <span class="string">`"<span class="subst">$&#123;relativeFile&#125;</span>" 中配置的 "<span class="subst">$&#123;key&#125;</span>" 并非约定的配置项，<span class="subst">$&#123;midMsg&#125;</span><span class="subst">$&#123;affixmsg&#125;</span>`</span>;</span><br><span class="line">        <span class="keyword">this</span>.printError(msg);</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(msg);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> config;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  setConfig(config) &#123;</span><br><span class="line">    <span class="keyword">this</span>.config = config;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  watchWithDevServer() &#123;</span><br><span class="line">    <span class="comment">// 配置插件的监听</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">const</span> plugin <span class="keyword">of</span> <span class="keyword">this</span>.plugins) &#123;</span><br><span class="line">      <span class="keyword">if</span> (plugin.watch) &#123;</span><br><span class="line">        plugin.watch();</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 配置文件的监听</span></span><br><span class="line">    <span class="keyword">this</span>.watchConfigs(<span class="function">(<span class="params">event, path</span>) =&gt;</span> &#123;</span><br><span class="line">      signale.debug(<span class="string">`[<span class="subst">$&#123;event&#125;</span>] <span class="subst">$&#123;path&#125;</span>`</span>);</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> newConfig = <span class="keyword">this</span>.getConfig(&#123;</span><br><span class="line">          force: <span class="literal">true</span>,</span><br><span class="line">          setConfig: <span class="function"><span class="params">newConfig</span> =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">this</span>.config = newConfig;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 从失败中恢复过来，需要 reload 一次</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.configFailed) &#123;</span><br><span class="line">          <span class="keyword">this</span>.configFailed = <span class="literal">false</span>;</span><br><span class="line">          <span class="keyword">this</span>.service.refreshBrowser();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">const</span> oldConfig = cloneDeep(<span class="keyword">this</span>.config);</span><br><span class="line">        <span class="keyword">this</span>.config = newConfig;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">const</span> plugin <span class="keyword">of</span> <span class="keyword">this</span>.plugins) &#123;</span><br><span class="line">          <span class="keyword">const</span> &#123; name &#125; = plugin;</span><br><span class="line">          <span class="keyword">if</span> (!isEqual(newConfig[name], oldConfig[name])) &#123;</span><br><span class="line">            <span class="keyword">this</span>.service.config[name] = newConfig[name];</span><br><span class="line">            <span class="keyword">this</span>.service.applyPlugins(<span class="string">'onConfigChange'</span>, &#123;</span><br><span class="line">              args: &#123;</span><br><span class="line">                newConfig</span><br><span class="line">              &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">            <span class="keyword">if</span> (plugin.onChange) &#123;</span><br><span class="line">              plugin.onChange(newConfig, oldConfig);</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">        <span class="keyword">this</span>.configFailed = <span class="literal">true</span>;</span><br><span class="line">        <span class="built_in">console</span>.error(chalk.red(<span class="string">`watch handler failed, since <span class="subst">$&#123;e.message&#125;</span>`</span>));</span><br><span class="line">        <span class="built_in">console</span>.error(e);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  watchConfigs(handler) &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; cwd &#125; = <span class="keyword">this</span>.service;</span><br><span class="line">    <span class="keyword">const</span> watcher = <span class="keyword">this</span>.watch(<span class="string">'CONFIG_FILES'</span>, getConfigPaths(cwd));</span><br><span class="line">    <span class="keyword">if</span> (watcher) &#123;</span><br><span class="line">      watcher.on(<span class="string">'all'</span>, handler);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> UserConfig;</span><br></pre></td></tr></table></figure>
<h4 id="packages-umi-build-dev-src-getPaths"><a href="#packages-umi-build-dev-src-getPaths" class="headerlink" title="packages/umi-build-dev/src/getPaths"></a>packages/umi-build-dev/src/getPaths</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">``</span><span class="string">`</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">#### packages/umi-build-dev/src/getPlugins</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">`</span><span class="string">``</span>js</span><br><span class="line"><span class="comment">//实现节点require.resolve() 算法 ，以便您可以require.resolve()异步和同步代表文件</span></span><br><span class="line"><span class="keyword">import</span> resolve <span class="keyword">from</span> <span class="string">'resolve'</span>;</span><br><span class="line"><span class="comment">//assert来自Node.js 的模块，用于浏览器。使用browserify，只需require('assert')或使用assert全局，您将获得此模块。目标是提供尽可能与Node.js assertAPI功能相同的API。阅读API文档的官方文档。</span></span><br><span class="line"><span class="keyword">import</span> assert <span class="keyword">from</span> <span class="string">'assert'</span>;</span><br><span class="line"><span class="keyword">import</span> chalk <span class="keyword">from</span> <span class="string">'chalk'</span>; <span class="comment">//终端字符串样式修改</span></span><br><span class="line"><span class="keyword">import</span> registerBabel, &#123; addBabelRegisterFiles &#125; <span class="keyword">from</span> <span class="string">'./registerBabel'</span>;</span><br><span class="line"><span class="keyword">import</span> isEqual <span class="keyword">from</span> <span class="string">'./isEqual'</span>;</span><br><span class="line"><span class="keyword">import</span> getCodeFrame <span class="keyword">from</span> <span class="string">'./utils/getCodeFrame'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> debug = <span class="built_in">require</span>(<span class="string">'debug'</span>)(<span class="string">'umi-build-dev:getPlugin'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="function"><span class="keyword">function</span>(<span class="params">opts = &#123;&#125;</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> &#123; cwd, plugins = [] &#125; = opts;</span><br><span class="line">  <span class="comment">// 内置插件</span></span><br><span class="line">  <span class="keyword">const</span> builtInPlugins = [</span><br><span class="line">    <span class="string">'./plugins/commands/dev'</span>,</span><br><span class="line">    <span class="string">'./plugins/commands/build'</span>,</span><br><span class="line">    <span class="string">'./plugins/commands/inspect'</span>,</span><br><span class="line">    <span class="string">'./plugins/commands/test'</span>,</span><br><span class="line">    <span class="string">'./plugins/commands/help'</span>,</span><br><span class="line">    <span class="string">'./plugins/commands/generate'</span>,</span><br><span class="line">    <span class="string">'./plugins/commands/rm'</span>,</span><br><span class="line">    <span class="string">'./plugins/commands/config'</span>,</span><br><span class="line">    <span class="string">'./plugins/commands/block'</span>,</span><br><span class="line">    <span class="comment">// './plugins/commands/ui',</span></span><br><span class="line">    <span class="string">'./plugins/commands/version'</span>,</span><br><span class="line">    <span class="string">'./plugins/global-js'</span>,</span><br><span class="line">    <span class="string">'./plugins/global-css'</span>,</span><br><span class="line">    <span class="string">'./plugins/base'</span>,</span><br><span class="line">    <span class="string">'./plugins/mountElementId'</span>,</span><br><span class="line">    <span class="string">'./plugins/mock'</span>,</span><br><span class="line">    <span class="string">'./plugins/proxy'</span>,</span><br><span class="line">    <span class="string">'./plugins/history'</span>,</span><br><span class="line">    <span class="string">'./plugins/afwebpack-config'</span>,</span><br><span class="line">    <span class="string">'./plugins/mountElementId'</span>,</span><br><span class="line">    <span class="string">'./plugins/404'</span>, <span class="comment">// 404 must after mock</span></span><br><span class="line">    <span class="string">'./plugins/targets'</span></span><br><span class="line">  ];</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> pluginsObj = [</span><br><span class="line">    <span class="comment">// builtIn 的在最前面</span></span><br><span class="line">    ...builtInPlugins.map(<span class="function"><span class="params">p</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">let</span> opts;</span><br><span class="line">      <span class="keyword">if</span> (<span class="built_in">Array</span>.isArray(p)) &#123;</span><br><span class="line">        opts = p[<span class="number">1</span>]; <span class="comment">// eslint-disable-line</span></span><br><span class="line">        p = p[<span class="number">0</span>];</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">const</span> apply = <span class="built_in">require</span>(p); <span class="comment">// eslint-disable-line</span></span><br><span class="line">      <span class="keyword">return</span> &#123;</span><br><span class="line">        id: p.replace(<span class="regexp">/^.\//</span>, <span class="string">'built-in:'</span>),</span><br><span class="line">        apply: apply.default || apply,</span><br><span class="line">        opts</span><br><span class="line">      &#125;;</span><br><span class="line">    &#125;),</span><br><span class="line">    ...getUserPlugins(process.env.UMI_PLUGINS ? process.env.UMI_PLUGINS.split(<span class="string">','</span>) : [], &#123; cwd &#125;),</span><br><span class="line">    ...getUserPlugins(plugins, &#123; cwd &#125;)</span><br><span class="line">  ];</span><br><span class="line"></span><br><span class="line">  debug(<span class="string">`plugins: \n<span class="subst">$&#123;pluginsObj.map(p =&gt; <span class="string">`  <span class="subst">$&#123;p.id&#125;</span>`</span>).join(<span class="string">'\n'</span>)&#125;</span>`</span>);</span><br><span class="line">  <span class="keyword">return</span> pluginsObj;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">pluginToPath</span>(<span class="params">plugins, &#123; cwd &#125;</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> (plugins || []).map(<span class="function"><span class="params">p</span> =&gt;</span> &#123;</span><br><span class="line">    assert(<span class="built_in">Array</span>.isArray(p) || <span class="keyword">typeof</span> p === <span class="string">'string'</span>, <span class="string">`Plugin config should be String or Array, but got <span class="subst">$&#123;chalk.red(<span class="keyword">typeof</span> p)&#125;</span>`</span>);</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> p === <span class="string">'string'</span>) &#123;</span><br><span class="line">      p = [p];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">const</span> [path, opts] = p;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> [</span><br><span class="line">        resolve.sync(path, &#123;</span><br><span class="line">          basedir: cwd</span><br><span class="line">        &#125;),</span><br><span class="line">        opts</span><br><span class="line">      ];</span><br><span class="line">    &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(</span><br><span class="line">        <span class="string">`</span></span><br><span class="line"><span class="string">Plugin <span class="subst">$&#123;chalk.underline.cyan(path)&#125;</span> can't be resolved</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">   Please try the following solutions:</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">     1. checkout the plugins config in your config file (.umirc.js or config/config.js)</span></span><br><span class="line"><span class="string">     <span class="subst">$&#123;path.charAt(<span class="number">0</span>) !== <span class="string">'.'</span> &amp;&amp; path.charAt(<span class="number">0</span>) !== <span class="string">'/'</span> ? <span class="string">`2. install <span class="subst">$&#123;chalk.underline.cyan(path)&#125;</span> via npm/yarn`</span> : <span class="string">''</span>&#125;</span></span></span><br><span class="line"><span class="string">`</span>.trim()</span><br><span class="line">      );</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getUserPlugins</span>(<span class="params">plugins, &#123; cwd &#125;</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> pluginPaths = pluginToPath(plugins, &#123; cwd &#125;);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 用户给的插件需要做 babel 转换</span></span><br><span class="line">  <span class="keyword">if</span> (pluginPaths.length) &#123;</span><br><span class="line">    addBabelRegisterFiles(pluginPaths.map(<span class="function"><span class="params">p</span> =&gt;</span> p[<span class="number">0</span>]), &#123; cwd &#125;);</span><br><span class="line">    registerBabel(&#123;</span><br><span class="line">      cwd</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> pluginPaths.map(<span class="function"><span class="params">p</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> [path, opts] = p;</span><br><span class="line">    <span class="keyword">let</span> apply;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      apply = <span class="built_in">require</span>(path); <span class="comment">// eslint-disable-line</span></span><br><span class="line">    &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(</span><br><span class="line">        <span class="string">`</span></span><br><span class="line"><span class="string">Plugin <span class="subst">$&#123;chalk.cyan.underline(path)&#125;</span> require failed</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"><span class="subst">$&#123;getCodeFrame(e)&#125;</span></span></span><br><span class="line"><span class="string">      `</span>.trim()</span><br><span class="line">      );</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      id: path.replace(makesureLastSlash(cwd), <span class="string">'user:'</span>),</span><br><span class="line">      apply: apply.default || apply,</span><br><span class="line">      opts</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">resolveIdAndOpts</span>(<span class="params">&#123; id, opts &#125;</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> &#123; id, opts &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">toIdStr</span>(<span class="params">plugins</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> plugins.map(<span class="function"><span class="params">p</span> =&gt;</span> p.id).join(<span class="string">'^^'</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 返回结果：</span></span><br><span class="line"><span class="comment"> *   pluginsChanged: true | false</span></span><br><span class="line"><span class="comment"> *   optionChanged: [ 'a', 'b' ]</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">diffPlugins</span>(<span class="params">newOption, oldOption, &#123; cwd &#125;</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> newPlugins = getUserPlugins(newOption, &#123; cwd &#125;).map(resolveIdAndOpts);</span><br><span class="line">  <span class="keyword">const</span> oldPlugins = getUserPlugins(oldOption, &#123; cwd &#125;).map(resolveIdAndOpts);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (newPlugins.length !== oldPlugins.length) &#123;</span><br><span class="line">    <span class="keyword">return</span> &#123; <span class="attr">pluginsChanged</span>: <span class="literal">true</span> &#125;;</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (toIdStr(newPlugins) !== toIdStr(oldPlugins)) &#123;</span><br><span class="line">    <span class="keyword">return</span> &#123; <span class="attr">pluginsChanged</span>: <span class="literal">true</span> &#125;;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      optionChanged: newPlugins.filter(<span class="function">(<span class="params">p, index</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> !isEqual(newPlugins[index].opts, oldPlugins[index].opts);</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">makesureLastSlash</span>(<span class="params">path</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> path.slice(<span class="number">-1</span>) === <span class="string">'/'</span> ? path : <span class="string">`<span class="subst">$&#123;path&#125;</span>/`</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="packages-umi-build-dev-src-utils-deprecate"><a href="#packages-umi-build-dev-src-utils-deprecate" class="headerlink" title="packages/umi-build-dev/src/utils/deprecate"></a>packages/umi-build-dev/src/utils/deprecate</h4><p>用于终端上提示方法被弃用,传入(方法名，…想要提示的其他信息),调用方法终端输出提示信息。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//process.platform属性返回字符串，标识Node.js进程运行其上的操作系统平台。</span></span><br><span class="line"><span class="keyword">const</span> isWindows = <span class="keyword">typeof</span> process !== <span class="string">'undefined'</span> &amp;&amp; process.platform === <span class="string">'win32'</span>;</span><br><span class="line"><span class="keyword">const</span> EOL = isWindows ? <span class="string">'\r\n'</span> : <span class="string">'\n'</span>;</span><br><span class="line"><span class="comment">//判断是否是windows更具系统选择换行符号</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> hits = &#123;&#125;;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="function"><span class="keyword">function</span> <span class="title">deprecate</span>(<span class="params">methodName, ...args</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (hits[methodName]) <span class="keyword">return</span>;</span><br><span class="line">  hits[methodName] = <span class="literal">true</span>;</span><br><span class="line">  <span class="comment">//process.stderr 属性返回连接到 stderr (fd 2) 的流。 它是一个 net.Socket 流（也就是双工流），除非 fd 2 指向一个文件，在这种情况下它是一个可写流。console.error() 内部分别是由它实现的。</span></span><br><span class="line">  <span class="keyword">const</span> stream = process.stderr;</span><br><span class="line">  <span class="comment">//判断 Node.js 是否在 TTY 上下文中运行的首选方法是检查 process.stdout.isTTY 属性的值是否为 true：</span></span><br><span class="line">  <span class="keyword">const</span> color = stream.isTTY &amp;&amp; <span class="string">'\x1b[31;1m'</span>;</span><br><span class="line">  <span class="comment">//如果上下文是终端设置亮黄色加粗字体</span></span><br><span class="line"></span><br><span class="line">  stream.write(EOL); <span class="comment">//终端写入换行</span></span><br><span class="line">  <span class="keyword">if</span> (color) &#123;</span><br><span class="line">    stream.write(color);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  stream.write(<span class="string">`Warning: <span class="subst">$&#123;methodName&#125;</span> has been deprecated.`</span>); <span class="comment">//警告方法名已经被弃用</span></span><br><span class="line">  stream.write(EOL); <span class="comment">//换行</span></span><br><span class="line">  args.forEach(<span class="function"><span class="params">message</span> =&gt;</span> &#123;</span><br><span class="line">    stream.write(message); <span class="comment">//打印参数</span></span><br><span class="line">    stream.write(EOL); <span class="comment">//换行</span></span><br><span class="line">  &#125;);</span><br><span class="line">  <span class="keyword">if</span> (color) &#123;</span><br><span class="line">    stream.write(<span class="string">'\x1b[0m'</span>);</span><br><span class="line">  &#125; <span class="comment">//把字体还原</span></span><br><span class="line">  stream.write(EOL);</span><br><span class="line">  stream.write(EOL);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

        </div>

        <blockquote class="post-copyright">
    <div class="content">
        
<span class="post-time">
    最后更新时间：<time datetime="2019-07-28T05:15:18.296Z" itemprop="dateUpdated">2019年07月28日 13:15:18</time>
</span><br>


        
        原文链接：<a href="/2019/study-umi/" target="_blank" rel="external">https://shawdanon.github.io/2019/study-umi/</a>
        
    </div>
    <footer>
        <a href="https://shawdanon.github.io">
            <img src="/img/avatar.jpg" alt="鬼厉">
            鬼厉
        </a>
    </footer>
</blockquote>

        
<div class="page-reward">
    <a id="rewardBtn" href="javascript:;" class="page-reward-btn waves-effect waves-circle waves-light">赏</a>
</div>



        <div class="post-footer">
            
	<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/前端/">前端</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/笔记/">笔记</a></li></ul>


            
<div class="page-share-wrap">
    

<div class="page-share" id="pageShare">
    <ul class="reset share-icons">
      <li>
        <a class="weibo share-sns" target="_blank" href="http://service.weibo.com/share/share.php?url=https://shawdanon.github.io/2019/study-umi/&title=《学习UMI》 — 草庙村&pic=https://shawdanon.github.io/img/avatar.jpg" data-title="微博">
          <i class="icon icon-weibo"></i>
        </a>
      </li>
      <li>
        <a class="weixin share-sns wxFab" href="javascript:;" data-title="微信">
          <i class="icon icon-weixin"></i>
        </a>
      </li>
      <li>
        <a class="qq share-sns" target="_blank" href="http://connect.qq.com/widget/shareqq/index.html?url=https://shawdanon.github.io/2019/study-umi/&title=《学习UMI》 — 草庙村&source=第一次认真学习开源项目，看一次开源代码…" data-title=" QQ">
          <i class="icon icon-qq"></i>
        </a>
      </li>
      <li>
        <a class="facebook share-sns" target="_blank" href="https://www.facebook.com/sharer/sharer.php?u=https://shawdanon.github.io/2019/study-umi/" data-title=" Facebook">
          <i class="icon icon-facebook"></i>
        </a>
      </li>
      <li>
        <a class="twitter share-sns" target="_blank" href="https://twitter.com/intent/tweet?text=《学习UMI》 — 草庙村&url=https://shawdanon.github.io/2019/study-umi/&via=https://shawdanon.github.io" data-title=" Twitter">
          <i class="icon icon-twitter"></i>
        </a>
      </li>
      <li>
        <a class="google share-sns" target="_blank" href="https://plus.google.com/share?url=https://shawdanon.github.io/2019/study-umi/" data-title=" Google+">
          <i class="icon icon-google-plus"></i>
        </a>
      </li>
    </ul>
 </div>



    <a href="javascript:;" id="shareFab" class="page-share-fab waves-effect waves-circle">
        <i class="icon icon-share-alt icon-lg"></i>
    </a>
</div>



        </div>
    </div>

    
<nav class="post-nav flex-row flex-justify-between">
  
    <div class="waves-block waves-effect prev">
      <a href="/2019/macOS/" id="post-prev" class="post-nav-link">
        <div class="tips"><i class="icon icon-angle-left icon-lg icon-pr"></i> Prev</div>
        <h4 class="title">macOS软件折腾记</h4>
      </a>
    </div>
  

  
    <div class="waves-block waves-effect next">
      <a href="/2019/typescript/" id="post-next" class="post-nav-link">
        <div class="tips">Next <i class="icon icon-angle-right icon-lg icon-pl"></i></div>
        <h4 class="title">typescript</h4>
      </a>
    </div>
  
</nav>



    














</article>

<div id="reward" class="page-modal reward-lay">
    <a class="close" href="javascript:;"><i class="icon icon-close"></i></a>
    <h3 class="reward-title">
        <i class="icon icon-quote-left"></i>
        赞助
        <i class="icon icon-quote-right"></i>
    </h3>
    <div class="reward-content">
        
        <div class="reward-code">
            <img id="rewardCode" src="/img/wechat.jpg" alt="打赏二维码">
        </div>
        
        <label class="reward-toggle">
            <input id="rewardToggle" type="checkbox" class="reward-toggle-check"
                data-wechat="/img/wechat.jpg" data-alipay="/img/alipay.jpg">
            <div class="reward-toggle-ctrol">
                <span class="reward-toggle-item wechat">微信</span>
                <span class="reward-toggle-label"></span>
                <span class="reward-toggle-item alipay">支付宝</span>
            </div>
        </label>
        
    </div>
</div>



</div>

        <footer class="footer">
    <div class="top">
        

        <p>
            
                <span><a href="/atom.xml" target="_blank" class="rss" title="rss"><i class="icon icon-lg icon-rss"></i></a></span>
            
            <span>博客内容遵循 <a rel="license" href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh">知识共享 署名 - 非商业性 - 相同方式共享 4.0 国际协议</a></span>
        </p>
    </div>
    <div class="bottom">
        <p><span>鬼厉 &copy; 2016 - 2019</span>
            <span>
                
                Power by <a href="http://hexo.io/" target="_blank">Hexo</a> Theme <a href="https://github.com/yscoder/hexo-theme-indigo" target="_blank">indigo</a>
            </span>
        </p>
    </div>
</footer>

    </main>
    <div class="mask" id="mask"></div>
<a href="javascript:;" id="gotop" class="waves-effect waves-circle waves-light"><span class="icon icon-lg icon-chevron-up"></span></a>



<div class="global-share" id="globalShare">
    <ul class="reset share-icons">
      <li>
        <a class="weibo share-sns" target="_blank" href="http://service.weibo.com/share/share.php?url=https://shawdanon.github.io/2019/study-umi/&title=《学习UMI》 — 草庙村&pic=https://shawdanon.github.io/img/avatar.jpg" data-title="微博">
          <i class="icon icon-weibo"></i>
        </a>
      </li>
      <li>
        <a class="weixin share-sns wxFab" href="javascript:;" data-title="微信">
          <i class="icon icon-weixin"></i>
        </a>
      </li>
      <li>
        <a class="qq share-sns" target="_blank" href="http://connect.qq.com/widget/shareqq/index.html?url=https://shawdanon.github.io/2019/study-umi/&title=《学习UMI》 — 草庙村&source=第一次认真学习开源项目，看一次开源代码…" data-title=" QQ">
          <i class="icon icon-qq"></i>
        </a>
      </li>
      <li>
        <a class="facebook share-sns" target="_blank" href="https://www.facebook.com/sharer/sharer.php?u=https://shawdanon.github.io/2019/study-umi/" data-title=" Facebook">
          <i class="icon icon-facebook"></i>
        </a>
      </li>
      <li>
        <a class="twitter share-sns" target="_blank" href="https://twitter.com/intent/tweet?text=《学习UMI》 — 草庙村&url=https://shawdanon.github.io/2019/study-umi/&via=https://shawdanon.github.io" data-title=" Twitter">
          <i class="icon icon-twitter"></i>
        </a>
      </li>
      <li>
        <a class="google share-sns" target="_blank" href="https://plus.google.com/share?url=https://shawdanon.github.io/2019/study-umi/" data-title=" Google+">
          <i class="icon icon-google-plus"></i>
        </a>
      </li>
    </ul>
 </div>


<div class="page-modal wx-share" id="wxShare">
    <a class="close" href="javascript:;"><i class="icon icon-close"></i></a>
    <p>扫一扫，分享到微信</p>
    <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMYAAADGCAAAAACs8KCBAAACMElEQVR42u3aQW7CQAwFUO5/aSp1VSlt+LYDamZeVgjUxA8k12P78Yiv5/f18/Xxnb8+Pd7n+OnzcD3ecWFgYNyW8Ty9joEmD07CSp6VxIaBgbEPI0mySTqepODk6/vzfQwMDIw4Bb/vNQYGBkYv4SZFW1TYxV8WBgbGzoykROu10qrhvv0sjoGBcUNGbzDw+XLwLfMNDAyMf894Dq75+DMvIl9EgoGBsTSjWtIlo8fk095axosIMTAwFmUkN80f/Jnm3S/3xMDA2IBxVaDno818hFD+N4CBgbE0oxdE78iapPVkPICBgbEzo3z2LbLP378qZWNgYOzJyB9cXc7I/7ZQwmJgYCzHyAOtDiDnA8tCQsfAwFiakR8se82ySVGYPwsDA2MHRvWm+dAxT6bVIvJFhYuBgbEQYzJEPA+oOoToJfHRL4CBgXErRrW9NWnx54fkfL0DAwNjB0beVstbcpO2WvkpGBgYGzB6CxbnhV1vnaJ69MXAwNiB0WuZ9ZYkJqsbURGJgYGxJaMadGEKUQRELTwMDIwNGDkyP3aWk+YgTgwMjLUZV6XC3uscUz5yY2BgLMHoHTt7yxnVVl1hjQwDA2NpRq/K6g0A8lQ7GTBgYGCsypivfPXSbvXYfFnXEAMD47aMapKtBlpd6SjzMDAwME4bcNWxQd5cK/QLMTAwMMarY72G2gWTWAwMjIUY1UCTllkyVKiOIjAwMPZkzAcD81IvX+y44BfDwMC4E+MLPyOJhw1Fy0UAAAAASUVORK5CYII=" alt="微信分享二维码">
</div>




    <script src="//cdn.bootcss.com/node-waves/0.7.4/waves.min.js"></script>
<script>
var BLOG = { ROOT: '/', SHARE: true, REWARD: true };


</script>

<script src="/js/main.min.js?v=1.7.1"></script>


<div class="search-panel" id="search-panel">
    <ul class="search-result" id="search-result"></ul>
</div>
<template id="search-tpl">
<li class="item">
    <a href="{path}" class="waves-block waves-effect">
        <div class="title ellipsis" title="{title}">{title}</div>
        <div class="flex-row flex-middle">
            <div class="tags ellipsis">
                {tags}
            </div>
            <time class="flex-col time">{date}</time>
        </div>
    </a>
</li>
</template>

<script src="/js/search.min.js?v=1.7.1" async></script>










</body>
</html>
